# ìƒí’ˆ ì£¼ë¬¸, ì¡°íšŒ, ì·¨ì†Œ

## âœï¸Â ìƒí’ˆ ì£¼ë¬¸ ê°œë°œ

### ğŸ“Â ClassÂ ìƒì„±ê³¼ DI

ì£¼ë¬¸ì€ ë“±ë¡ëœ ì£¼ë¬¸ì ì •ë³´ì™€ ìƒí’ˆ ì •ë³´ë¥¼ ì·¨í•©ì´ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— Member, Item Service ë„ ìƒì„±í•´ì¤€ë‹¤.

```java
@Controller
@RequiredArgsConstructor
public class OrderController {

    private final OrderService orderService;
    private final MemberService memberService;
    private final ItemService itemService;
```

<br>

### ğŸ“Â createForm

ì‚¬ìš©ìê°€ ëª¨ë“  íšŒì›ê³¼ ìƒí’ˆ ì •ë³´ ì¤‘ì—ì„œ ì›í•˜ëŠ” í•­ëª©ì„ ê³ ë¥¼ ìˆ˜ ìˆê²Œ DB ì— ë“±ë¡ëœ ëª¨ë“  ì •ë³´ë¥¼ í˜¸ì¶œí•œë‹¤.

- html ì€ addAttribute ë¡œ ë„˜ê²¨ë°›ì€ ì •ë³´ë¥¼ each ë¬¸ìœ¼ë¡œ ë°˜ë³µí•´ DB ë“±ë¡ëœ ëª¨ë“  ì •ë³´ë¥¼ ì„ íƒí•  ìˆ˜ ìˆê²Œ ì¶œë ¥í•œë‹¤.

```java
		@GetMapping("/order")
    public String createForm(Model model) {

				// DB ì— ë“±ë¡ëœ ì •ë³´ë¥¼ ëª¨ë‘ í˜¸ì¶œí•˜ëŠ” Method ì‹¤í–‰
        List<Member> members = memberService.findMembers();
        List<Item> items = itemService.findItems();

				// html ì˜ Key ê°’ì— ë§ì¶° ì •ë³´ë¥¼ ë„˜ê²¨ì¤Œ
        model.addAttribute("members", members);
        model.addAttribute("items", items);

        return "order/orderForm";
    }
```

<br>

### ğŸ“Â order

Form Submit ë°©ì‹ìœ¼ë¡œ ì‘ë™ëœë‹¤.

- @RequestParam ì˜ parameter ê°’ì— ë§ëŠ” html ì˜ name ê°’ê³¼ ì—°ê²°ëœë‹¤.
- ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ì •ë³´ë¥¼ ì„ íƒí•˜ë©´ html ì˜ value ê°’ì— data ì˜ id ê°’ì´ ë“¤ì–´ì˜¤ê³  order Method ì˜ parameter ê°’ìœ¼ë¡œ ë„˜ê²¨ë°›ëŠ”ë‹¤.

```java
package jpabook.jpashop.controller;

import jpabook.jpashop.domain.Member;
import jpabook.jpashop.domain.item.Item;
import jpabook.jpashop.service.ItemService;
import jpabook.jpashop.service.MemberService;
import jpabook.jpashop.service.OrderService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;

import java.util.List;

@Controller
@RequiredArgsConstructor
public class OrderController {

    private final OrderService orderService;
    private final MemberService memberService;
    private final ItemService itemService;

    @GetMapping("/order")
    public String createForm(Model model) {

        List<Member> members = memberService.findMembers();
        List<Item> items = itemService.findItems();

        model.addAttribute("members", members);
        model.addAttribute("items", items);

        return "order/orderForm";
    }

		// @RequestParam ìœ¼ë¡œ ì—°ê²°í•´ ì‚¬ìš©ìê°€ ì„ íƒí•œ data ë¥¼ ë°›ì•„ì˜´
    @PostMapping("/order")
    public String order(@RequestParam("memberId") Long memberId,
                        @RequestParam("itemId") Long itemId,
                        @RequestParam("count") int count) {

        orderService.order(memberId, itemId, count);
        return "redirect:/";
    }
}
```

<br>

### ğŸ“order/orderForm.html

```java
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header" />
<body>
<div class="container">
    <div th:replace="fragments/bodyHeader :: bodyHeader"/>

    <form role="form" action="/order" method="post">

			  // addAttribute ì˜ key ê°’ìœ¼ë¡œ option ì˜ each ë¬¸ì„ í†µí•´ data ë¥¼ ì¶œë ¥í•¨
				// ì‚¬ìš©ìê°€ ì„ íƒí•œ value ê°’ì„ RequestParam ì„ í†µí•´ ë°›ì•„ì˜´
        <div class="form-group">
            <label for="member">ì£¼ë¬¸íšŒì›</label>
            <select name="memberId" id="member" class="form-control">
                <option value="">íšŒì›ì„ íƒ</option>
                <option th:each="member : ${members}"
                        th:value="${member.id}"
                        th:text="${member.name}" />
            </select>
        </div>

        <div class="form-group">
            <label for="item">ìƒí’ˆëª…</label>
            <select name="itemId" id="item" class="form-control">
                <option value="">ìƒí’ˆì„ íƒ</option>
                <option th:each="item : ${items}"
                        th:value="${item.id}"
                        th:text="${item.name}" />
            </select>
        </div>

        <div class="form-group">
            <label for="count">ì£¼ë¬¸ìˆ˜ëŸ‰</label>
            <input type="number" name="count" class="form-control" id="count" placeholder="ì£¼ë¬¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>

        <button type="submit" class="btn btn-primary">Submit</button>

    </form>
    <br/>
    <div th:replace="fragments/footer :: footer" />
</div> <!-- /container -->
</body>
</html>
```

<br>

## âœï¸Â ìƒí’ˆ ì¡°íšŒ

ìƒí’ˆì„ ì¡°íšŒí•˜ê¸°ìœ„í•œ ë¡œì§ì´ í•„ìš”í•œë°,

 ì´ì „ì— Order Repositorty ë§Œë“¤ì–´ë‘” `findAllByCriteria` ë¥¼ ì´ìš©í•´ Service ì— ë¡œì§ì„ ë§ˆë¬´ë¦¬í•´ì„œ Controller ì—ì„œ ì‚¬ìš©í•œë‹¤.

[ğŸ”—Â ì˜ˆì „ì— ë§Œë“¤ì—ˆë˜ ì£¼ë¬¸ ê²€ìƒ‰ ë¡œì§](https://github.com/choideakook/TIL/blob/main/Spring/3%20JPA%20í™œìš©1/3%20Application%20ê°œë°œ/230108%203%20ì£¼ë¬¸%20ê²€ìƒ‰%20ê¸°ëŠ¥.md)

<br>

### ğŸ“Â Order Service

Repository ì˜ ë¡œì§ì„ í˜¸ì¶œí•´ì„œ method ìƒì„±

- ì‚¬ì‹¤ ì´ë ‡ê²Œ service ê°€ ì „ë‹¬ë§Œ í•  ì •ë„ë¡œ ë‹¨ìˆœí•œ ë¡œì§ì€ Controller ì—ì„œ ë°”ë¡œ í˜¸ì¶œí•´ì„œ ì‚¬ìš©í•´ë„ëœë‹¤.

```java
		/**
     * ì£¼ë¬¸ ê²€ìƒ‰
     */
    public List<Order> findOrders(OrderSearch orderSearch) {
        return orderRepository.findAllByCriteria(orderSearch);
    }
```

<br>

### ğŸ“Â orderList

- ModelAttribute ë¡œ html ì˜ key ê°’ì— Order Search ê°’ì„ ë„£ì–´ì¤„ ìˆ˜ ìˆìŒ
    - find ë¡œ ì°¾ì€ search ê°’ì´ orders ê°ì²´ë¡œ ì…ë ¥ë˜ê³ ,
    - ê·¸ ê°’ì´ model attribute ë¡œ html ë¡œ ë„˜ê²¨ì§€ê²Œ ëœë‹¤.
    - ë„˜ê²¨ì§„ order ì•ˆì˜ key ê°’ â€œorderSearchâ€ ê°€ html ê³¼ ì—°ê²°ëœë‹¤.

```java
		@GetMapping("/orders")
    public String orderList(@ModelAttribute("orderSearch") OrderSearch orderSearch, Model model) {
        List<Order> orders = orderService.findOrders(orderSearch);
        model.addAttribute("orders", orders);
        return "order/orderList";
    }
```

<br>

### ğŸ“order/orderList.html - ì•„ë¬´ê²ƒë„ ì…ë ¥í•˜ì§€ ì•Šì„ê²½ìš°

- form ì—ì„œ object ë¡œ order Search ë¥¼ ë°›ì•„ì˜´
    - search ì•ˆì˜ í•„ë“œ memberName ê³¼ orderStatus ë¥¼ key ê°’ìœ¼ë¡œ ì—°ê²°ëœë‹¤.
    - search ì— ì•„ì§ ì•„ë¬´ ê°’ë„ ì—†ìœ¼ë¯€ë¡œ web ì—ëŠ” ê³µë€ìœ¼ë¡œ ë‚˜íƒ€ë‚œë‹¤.
    - submit button ì„ ëˆ„ë¥´ë©´ ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì •ë³´ê°€ Search í•„ë“œì— ë°”ì¸ë”© ë˜ì–´ ê°’ì´ ì±„ì›Œì§„ë‹¤.
    - Order Status ì˜ ê°’ì€ enum ìœ¼ë¡œ ì €ì¥ë˜ì–´ìˆëŠ”ë° each ë¬¸ì„ í†µí•´ í•„ë“œê°€ ì…€ë ‰ ë°•ìŠ¤ì— ëª¨ë‘ ì…ë ¥ë˜ì–´ ë‚˜íƒ€ë‚œë‹¤.

```java
<form th:object="${orderSearch}" class="form-inline">
                <div class="form-group mb-2">
                    <input type="text" th:field="*{memberName}" class="form-control" placeholder="íšŒì›ëª…"/>
                </div>
                <div class="form-group mx-sm-1 mb-2">
                    <select th:field="*{orderStatus}" class="form-control">
                        <option value="">ì£¼ë¬¸ìƒíƒœ</option>
                        <option th:each="status : ${T(jpabook.jpashop.domain.OrderStatus).values()}"
                                th:value="${status}"
                                th:text="${status}">option</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary mb-2">ê²€ìƒ‰</button>

            </form>
```

<br>

### ğŸ“Â order/orderList.html - ê°’ì„ ì…ë ¥í•  ê²½ìš°

- Search ê°€ ë°”ì¸ë”© ëœ í›„  submit ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ orderList Method ê°€ ë‹¤ì‹œ url ì„  GetMapping í•´ ë‹¤ìŒ ì‘ì—…ì„ ì§„í–‰í•œë‹¤.
    - ì´ì œ search ê°’ì´ ì¡´ì¬í•˜ë¯€ë¡œ ê°’ì´ ì±„ì›Œì§„ ì±„ë¡œ web ì— ë‚˜íƒ€ë‚œë‹¤.
- table ì—ì„œ ì…ë ¥í•œ ê°’ì„ ê¸°ë°˜ìœ¼ë¡œ ì •ë³´ë“¤ì„ ì¶œë ¥í•´ì¤€ë‹¤.

```java
        <table class="table table-striped">
            <thead>
            <tr>
                <th>#</th>
                <th>íšŒì›ëª…</th>
                <th>ëŒ€í‘œìƒí’ˆ ì´ë¦„</th>
                <th>ëŒ€í‘œìƒí’ˆ ì£¼ë¬¸ê°€ê²©</th>
                <th>ëŒ€í‘œìƒí’ˆ ì£¼ë¬¸ìˆ˜ëŸ‰</th>
                <th>ìƒíƒœ</th>
                <th>ì¼ì‹œ</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item : ${orders}">
                <td th:text="${item.id}"></td>
                <td th:text="${item.member.name}"></td>
                <td th:text="${item.orderItems[0].item.name}"></td>
                <td th:text="${item.orderItems[0].orderPrice}"></td>
                <td th:text="${item.orderItems[0].count}"></td>
                <td th:text="${item.status}"></td>
                <td th:text="${item.orderDate}"></td>
                <td>
                    <a th:if="${item.status.name() == 'ORDER'}" href="#"
                       th:href="'javascript:cancel('+${item.id}+')'"
                       class="btn btn-danger">CANCEL</a>
                </td>
            </tr>

            </tbody>
        </table>
    </div>
```

<br>

## âœï¸Â ì£¼ë¬¸ ì·¨ì†Œ

table ì˜ ëë¶€ë¶„ì— order status ê°€ ORDER ì¼ê²½ìš° ë‚˜íƒ€ë‚˜ê²Œ ë˜ëŠ” cancle ë²„íŠ¼ì´ ìˆë‹¤.

```java
<a th:if="${item.status.name() == 'ORDER'}" href="#"
   th:href="'javascript:cancel('+${item.id}+')'"
   class="btn btn-danger">CANCEL</a>
```

ì´ ë¡œì§ì„ ì‹¤í–‰í•˜ë©´ ìë°”ìŠ¤í¬ë¦½íŠ¸ê°€ í˜¸ì¶œëœë‹¤.

```java
<div th:replace="fragments/footer :: footer"/>

</div> <!-- /container -->
</body>
<script>
    function cancel(id) {
        var form = document.createElement("form");
        form.setAttribute("method", "post");
        form.setAttribute("action", "/orders/" + id + "/cancel");
        document.body.appendChild(form);
        form.submit();
    }
</script>
</html>
```

ìë°”ìŠ¤í¬ë¦½íŠ¸ëŠ” post ë°©ì‹ìœ¼ë¡œ "/orders/" + id + "/cancel" ì„ í˜¸ì¶œí•˜ê²Œëœë‹¤.

- ì´ê±¸ Controller ì—ì„œ Post ë¡œ mapping í•˜ë©´ëœë‹¤.

<br>

### ğŸ“Â cancelOrder

@PathVariable ìœ¼ë¡œ id ê°’ì„ ê°€ì ¸ì™€ cancel í•´ì¤€ë‹¤.

```java
		@PostMapping("/orders/{orderId}/cancel")
    public String cancelOrder(@PathVariable("orderId") Long orderId) {
        orderService.cancelOrder(orderId);
        return "redirect:/orders";
    }
```

<br>

ëª¨ë“  ê¸°ëŠ¥ì´ ì •ìƒì ìœ¼ë¡œ ì˜ ì‘ë™ëœë‹¤.