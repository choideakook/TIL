# íšŒì› ê¸°ëŠ¥ Test

[ğŸ”— AssertJ ê³µì‹ ë¬¸ì„œ](https://assertj.github.io/doc/#overview-what-is-assertj)
## âœï¸ Test ìš”êµ¬ì‚¬í•­

- íšŒì› ê°€ì… ì„±ê³µ
- íšŒì› ê°€ì…ì‹œ ì¤‘ë³µì´ ìˆì„ ê²½ìš° ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•œë‹¤.

<br>

## âœï¸  Test ìš© ë©”ëª¨ë¦¬ DB ìƒì„± (ì„ë² ë””ë“œ ëª¨ë“œ DB)

[ğŸ”— ì„ë² ë””ë“œ ëª¨ë“œ DB](https://github.com/choideakook/TIL/blob/main/Spring/7%20DB%20ì ‘ê·¼%20í™œìš©/2%20DB%20ì ‘ê·¼%20ê¸°ìˆ %20Test/230203%202%20Test%20ì„ë² ë””ë“œ%20ëª¨ë“œ%20DB.md)  
Test case ëŠ” ë§ ê·¸ëŒ€ë¡œ ë‚´ê°€ ë§Œë“  ë¡œì§ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ì‘ì—…ì´ê¸° ë•Œë¬¸ì— DB ì— ì €ì¥ì´ ë˜ì–´ì„œëŠ” ì•ˆë˜ê³ , ë‹¤ì–‘í•œ ë°©ì‹ìœ¼ë¡œ ê²€ì¦ì´ í•„ìš”í•´ ì»´íŒŒì¼ì„ ì—¬ëŸ¬ë²ˆ ì§„í–‰í•´ì•¼í•œë‹¤.

ì´ë•Œ ì™¸ë¶€ DB ë¥¼ ì—°ê²°í•´ì„œ test ë¥¼ í•˜ëŠ”ê²ƒë³´ë‹¤ ìì²´ ë©”ëª¨ë¦¬ DB ë¥¼ ì‚¬ìš©í•˜ëŠ”ê²Œ ë” íš¨ìœ¨ì ì´ë‹¤.

<br>

### ğŸ“Â h2 ë©”ëª¨ë¦¬ DB ì‚¬ìš©ë°©ë²•

- Test í´ë”ì— resources ë¥¼ ìƒì„±í•˜ê³  application.yml íŒŒì¼ì„ ë³µì‚¬ ë¶™ì—¬ë„£ê¸° í•œë‹¤.
    - ì´ë ‡ê²Œ test ì— ìƒì„±ëœ application ì€ main ì— ìˆëŠ” application ë³´ë‹¤ ìš°ì„ ê¶Œì„ ê°€ì§„ë‹¤.
- datasource ì˜ url ì„ ë©”ëª¨ë¦¬ ëª¨ë“œ url ë¡œ ìˆ˜ì •
    - jdbc:h2:mem:test

```java
spring:
  datasource:
    url: jdbc:h2:mem:test  // ë©”ëª¨ë¦¬ ëª¨ë“œë¡œ url ìˆ˜ì •
    username: sa
    password:
    driver-class-name: org.h2.Driver
```

ì´ë ‡ê²Œ í•˜ë©´ h2 ì—°ê²°ì„ ì¢…ë£Œí•´ë„ test ëŠ” ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ê²Œ ëœë‹¤.

<br>

### ğŸ“Â Spring ìì²´ ë©”ëª¨ë¦¬ DB ì‚¬ìš©ë°©ë²•

- url ì—†ì´ datasource ì™€ jpa ë¥¼ ì „ë¶€ ë¹„í™œì„±í™” í•´ì£¼ë©´ Spring ìì²´ì—ì„œ ë©”ëª¨ë¦¬ DB ë¥¼ ì‚¬ìš©í•´ test ë¥¼ ì‹¤í–‰í•œë‹¤.

```java
spring:
#  datasource:
#    url: jdbc:h2:mem:test
#    username: sa
#    password:
#    driver-class-name: org.h2.Driver
#
#  jpa:
#    hibernate:
#      ddl-auto: create
#    properties:
#      hibernate:
##        show_sql: true
#        format_sql: true

logging.level:
  org.hibernate.SQL: debug
  org.hibernate.type: trace
```

<br>

## âœï¸ Test ì‹¤í–‰
member instance ë¡œ ìƒì„±í•œ member,  
service ì—ì„œ ì°¾ì€ member,  
repository ì—ì„œ ì°¾ì€ member  
3 ê°€ì§€ member ê°€ ë™ì¼í•˜ê²Œ ì¸ì‹ëœ ì´ìœ   
- JPA ë¥¼ ì‚¬ìš©í•  ë•Œ ê°™ì€ Transaction í•˜ì˜ ê°™ì€ Entity (ID ê°’ì´ ê°™ì€ê²½ìš°) ëŠ”  
    ê°™ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¡œ ì¸ì‹ë˜ì–´ ë˜‘ê°™ì´ ê´€ë¦¬ê°€ ëœë‹¤.  
    ì¦‰ PK ê°€ ê°™ìœ¼ë©´ ê°’ìœ¼ë¡œ ì¸ì‹ëœë‹¤.  

```java
package jpabook.jpashop.service;

import jpabook.jpashop.domain.Member;
import jpabook.jpashop.repository.MemberRepository;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.transaction.annotation.Transactional;

import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.jupiter.api.Assertions.*;

@SpringBootTest
@Transactional
class MemberServiceTest {

    @Autowired MemberService memberService;
    @Autowired MemberRepository memberRepository;
    @Autowired private EntityManager em;

    @Test
//    @Rollback (value = false)
    void íšŒì›ê°€ì…() {
        Member member = new Member();
        member.setName("Kim");

        Long join = memberService.join(member);
        Member memberId = memberService.findOne(member.getId());

        // flush ë¥¼ í•œ í›„ test ë¥¼ ì‹¤í–‰í•˜ë©´
        // db ì— SQL ë¬¸ì„ ìš”ì²­í•˜ëŠ” ê²ƒ ê¹Œì§€ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
        // ì°¸ê³ ë¡œ Transactional ë•Œë¬¸ì— ë§ˆì§€ë§‰ì—” rollback ìœ¼ë¡œ 
        em.flush();
        assertThat(member.getId()).isEqualTo(join);
        assertThat(member.getId()).isEqualTo(memberId.getId());
        assertThat(member).isSameAs(memberRepository.findOne(join));
    }

    @Test
    void ì¤‘ë³µ_íšŒì›_ì˜ˆì™¸(){

        Member member1 = new Member();
        Member member2 = new Member();
        member1.setName("member1");
        member2.setName("member1");

        memberService.join(member1);

        IllegalStateException e = assertThrows(IllegalStateException.class,
                () -> memberService.join(member2));
    }
}
```
