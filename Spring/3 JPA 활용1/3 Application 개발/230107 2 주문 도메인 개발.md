# ì£¼ë¬¸ ë„ë©”ì¸ ê°œë°œ

ë„ë©”ì¸ ê°œë°œì—ì„œ ì£¼ë¬¸ ë„ë©”ì¸ì´ ê°€ì¥ ì¤‘ìš”í•˜ë‹¤.

## âœï¸Â êµ¬í˜„ ê¸°ëŠ¥

- ìƒí’ˆ ì£¼ë¬¸
- ì£¼ë¬¸ ë‚´ì—­ ì¡°íšŒ
- ì£¼ë¬¸ ì·¨ì†Œ

<br>

## âœï¸Â ìˆœì„œ

- ì£¼ë¬¸ Entity , ì£¼ë¬¸ ìƒí’ˆ Entity ê°œë°œ
- ì£¼ë¬¸ Repository ê°œë°œ
- ì£¼ë¬¸ Service ê°œë°œ
- ì£¼ë¬¸ ê²€ìƒ‰ ê¸°ëŠ¥ ê°œë°œ
- ì£¼ë¬¸ ê¸°ëŠ¥ Test

<br>

## âœï¸Â ì£¼ë¬¸ , ì£¼ë¬¸ ìƒí’ˆ Entity ê°œë°œ

### ğŸ“Â ì£¼ë¬¸ Entity ê°œë°œ

- Order : ì£¼ë¬¸ì ì •ë³´ (member) , ë°°ì†¡ì •ë³´ (delivery), ì£¼ë¬¸ ìƒí’ˆ ì •ë³´ë“¤ (order items) ì„ ì·¨í•©í•´ì„œ ì •ë¦¬í•˜ëŠ” ì—­í• 
    - ìƒì„± Method â†’ ìƒì„± method ëŠ” static ìœ¼ë¡œ!
        - createOrder : ì—°ê´€ê´€ê³„ Class ë“¤ë¡œ ë¶€í„° ì •ë³´ë¥¼ ì·¨í•©í•´ ìµœì¢…ì ìœ¼ë¡œ Order ìƒì„±
    - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
        - cancel : Order ì·¨ì†Œ â†’ ì¬ê³  ê´€ë¦¬ëŠ” OrderItem ì´ ë‹´ë‹¹í•¨
    - ì¡°íšŒ ë¡œì§
        - getTotalPrice : Order ì˜ Price ì´ í•© â†’ ì£¼ë¬¸ ìƒí’ˆ ê°€ê²©ì€ OrderItem ì´ ë‹´ë‹¹í•¨

```java
package jpabook.jpashop.domain;

import lombok.Getter;
import lombok.Setter;

import javax.persistence.*;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Entity
@Table (name = "orders")
@Getter @Setter
// ë‹¤ë¥¸ Class ì—ì„œ í•¨ë¶€ë¡œ intance ë¥¼ ìƒì„±í•˜ì§€ ëª»í•˜ê²Œ í•˜ëŠ” ì—ë…¸í…Œì´ì…˜
@NoArgsConstructor (access = AccessLevel.PROTECTED)
public class Order {

    @Id @GeneratedValue
    @Column (name = "order_id")
    private Long id;

    @ManyToOne (fetch = FetchType.LAZY)
    @JoinColumn (name = "member_id")
    private Member member;

    @OneToMany (mappedBy = "order" , cascade = CascadeType.ALL)
    private List<OrderItem> orderItems = new ArrayList<>();

    @OneToOne (fetch = FetchType.LAZY , cascade = CascadeType.ALL)
    @JoinColumn (name = "delivery_id")
    private Delivery delivery;

    private LocalDateTime orderDate;

    @Enumerated (EnumType.STRING)
    private OrderStatus status;

    //== ì—°ê´€ê´€ê³„ Method ==//
    public void setMember(Member member) {
        this.member = member;
        member.getOrders().add(this);
    }

    public void addOrderItem(OrderItem orderItem) {
        orderItems.add(orderItem);
        orderItem.setOrder(this);
    }

    public void setDelivery(Delivery delivery) {
        this.delivery = delivery;
        delivery.setOrder(this);
    }

//    ë‹¤ë¥¸ Class ì—ì„œ instance ë¥¼ í•¨ë¶€ë¡œ ìƒì„±ì„ ëª»í•˜ê²Œ ë§‰ëŠ” method
//    lombok ìœ¼ë¡œë„ ê°™ì€ íš¨ê³¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ
//    @NoArgsConstructor (access = AccessLevel.PROTECTED)

//    protected Order() {
//    }  -> instance ìƒì„±í•˜ì§€ ë§ê³  ìƒì„± method ë¥¼ ì‚¬ìš©í•˜ë¼ëŠ” ì˜ë¯¸

    //== ìƒì„± Method ==//
    // ì™¸ë¶€ Class ì—ì„œ set ìœ¼ë¡œ í•„ë“œë¥¼ ê°ê° ì£¼ì…í•´ì£¼ëŠ” ë°©ì‹ì´ ì•„ë‹Œ,
    // create Method ì‹¤í–‰ìœ¼ë¡œ í•œë²ˆì— ì™„ì„±í•  ìˆ˜ ìˆê²Œ ì„¤ê³„íšŒ
    // í•´ë‹¹ method ê°€ ì‹¤í–‰ë˜ë©´ ì—°ê´€ê´€ê³„ë¥¼ ìƒíƒœì™€ ì‹œê°„ê¹Œì§€ ëª¨ë‘ ì„¸íŒ…í•´ì£¼ê³  ìƒì„±ì´ ë¨
    // ì•ìœ¼ë¡œ oder ë¥¼ ìƒì„±í•  ë• í•´ë‹¹ method ë§Œ ì‹¤í–‰í•˜ë©´ë¨
    // ê³ ê°ì´ í•œë²ˆì— ì—¬ëŸ¬ ìƒí’ˆì„ ì£¼ë¬¸í•  ìˆ˜ ìˆìœ¼ë‹ˆ OrderItem ê°€ë³€ì¸ìë¡œ ì‚¬ìš©
    public static Order createOrder(Member member, Delivery delivery, OrderItem... orderItems) {
        Order order = new Order();
        order.setMember(member);
        order.setDelivery(delivery);
        for (OrderItem orderItem : orderItems) {
            order.addOrderItem(orderItem);
        }
        order.setStatus(OrderStatus.ORDER);
        order.setOrderDate(LocalDateTime.now());
        return order;
    }

    //== ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§==//
    /**
     * ì£¼ë¬¸ ì·¨ì†Œ
     */
    public void cancel () {
				// ë°°ì†¡ì´ ì‹œì‘ë˜ë©´ ì·¨ì†Œê°€ ë¶ˆê°€ëŠ¥í•˜ê²Œ ì„¤ê³„í•¨
        if (delivery.getStatus() == DeliveryStatus.COMP) {
            throw new IllegalStateException("item that have already been delivered cannot be canceled");
        }
        this.setStatus(OrderStatus.CANCEL);
        // orderIems ì— ë‹´ê²¨ìˆëŠ” ì£¼ë¬¸ ì—¬ëŸ¬ê°œë¥¼ each ë¬¸ì„ ëŒë©° ì „ë¶€ ì‚­ì œí•´ì¤Œ
        for (OrderItem orderItem : orderItems) {
            orderItem.cancel();
        }
    }

    //== ì¡°íšŒ ë¡œì§ ==//
    /**
     * ì „ì²´ ì£¼ë¬¸ ê°€ê²© ì¡°íšŒ
     */
    public int getTotalPrice(){
        int totalPrice = 0;
        for (OrderItem orderItem : orderItems) {
            totalPrice += orderItem.getTotalPrice();
        }
        return totalPrice;
    }
}
```

<br>

### ğŸ“Â ì£¼ë¬¸ ìƒí’ˆ Entity ê°œë°œ

- OrderItem : Item Class ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì£¼ë¬¸ëœ ìƒí’ˆë“¤ì„ ì·¨í•©í•´ì„œ ì •ë¦¬í•˜ëŠ” ì—­í• 
    - ìƒì„± Method â†’ ìƒì„± method ëŠ” static ìœ¼ë¡œ!
        - createOrderItem : Item Class ì˜ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ order item ìƒì„± (ì¬ê³ ëŠ” Itemì´  ë‹´ë‹¹)
    - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
        - cancel : itema ì˜ ì¬ê³ ë¥¼ ì±„ì›Œë†“ìŒ (ì£¼ë¬¸ ì·¨ì†ŒëŠ” Order ê°€ ë‹´ë‹¹í•¨)
    - ì¡°íšŒ ë¡œì§
        - getTotalPrice : í˜„ì¬ í•„ë“œê°’ìœ¼ë¡œ ìˆëŠ” ìƒí’ˆ ê¸ˆì•¡ì˜ í•©ê³„ë¥¼ ê³„ì‚° (ìµœì¢… í•©ê³„ëŠ” Order ê°€ ë‹´ë‹¹)

```java
package jpabook.jpashop.domain;

import jpabook.jpashop.domain.item.Item;
import lombok.Getter;
import lombok.Setter;

import javax.persistence.*;

@Entity
@Table(name = "order_item")
@Getter @Setter
public class OrderItem {

    @Id @GeneratedValue
    @Column (name = "order_item_id")
    private Long id;

    @ManyToOne (fetch = FetchType.LAZY)
    @JoinColumn (name = "item_id")
    private Item item;

    @ManyToOne (fetch = FetchType.LAZY)
    @JoinColumn (name = "order_id")
    private Order order;

    private int orderPrice;

    private int count;

		// ë‹¤ë¥¸ Class ì—ì„œ instance ë¥¼ í•¨ë¶€ë¡œ ìƒì„±ì„ ëª»í•˜ê²Œ ë§‰ëŠ” method
		// lombok ìœ¼ë¡œë„ ê°™ì€ íš¨ê³¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ
		// @NoArgsConstructor (access = AccessLevel.PROTECTED)
    protected OrderItem() {
    } // -> instance ìƒì„±í•˜ì§€ ë§ê³  ìƒì„± method ë¥¼ ì‚¬ìš©í•˜ë¼ëŠ” ì˜ë¯¸

    //== ìƒì„± Method ==//
    // item ì—ì„œ orderPrice ë¥¼ êº¼ë‚´ë„ ë˜ì§€ë§Œ,
    // orderPrice ê°€ í• ì¸ì´ ì ìš© ë  ìˆ˜ë„ ìˆê³ , ì¿ í°ì´ ì ìš© ë  ìˆ˜ë„ ìˆê¸°ë•Œë¬¸ì—
    // ë”°ë¡œ Parameter ë¡œ ë°›ì•„ì˜¤ëŠ”ê²ƒì´ ë” ì¢‹ë‹¤.
    public static OrderItem createOrderItem(Item item, int orderPrice, int count) {
        OrderItem orderItem = new OrderItem();
        orderItem.setItem(item);
        orderItem.setOrderPrice(orderPrice);
        orderItem.setCount(count);

        item.removaeStock(count);
        return orderItem;
    }

    //== ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ==//
    public void cancel() {
        getItem().addStock(count);
    }

    //== ì¡°íšŒ ë¡œì§ ==//

    public int getTotalPrice() {
        return getOrderPrice() * getCount();
    }
}
```

### ğŸ“Â Item Entity ê°œë°œ

- Item : ê°ê° ê°œë³„ ìƒí’ˆì˜ ì¬ê³ ì™€ ê°€ê²© ë“± ìƒˆë¶€ì •ë³´ë¥¼ ê´€ë¦¬í•˜ëŠ” ì—­í• 
    - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (ì£¼ë¬¸ ìƒì„± , ì·¨ì†ŒëŠ” OrderItema ì´ ë‹´ë‹¹í•¨)
        - addStock : ì¬ê³  ìˆ˜ëŸ‰ ì¶”ê°€
        - removeStock : ì¬ê³  ìˆ˜ëŸ‰ ê°ì†Œ

```java
package jpabook.jpashop.domain.item;

import jpabook.jpashop.domain.Category;
import jpabook.jpashop.exception.NotEnoughStockException;
import lombok.Getter;
import lombok.Setter;

import javax.persistence.*;
import java.util.ArrayList;
import java.util.List;

@Entity
@Inheritance (strategy = InheritanceType.SINGLE_TABLE)
@DiscriminatorColumn (name = "dtype")
@Getter @Setter
public abstract class Item {

    @Id @GeneratedValue
    @Column (name = "item_id")
    private Long id;

    private String name;
    private int price;
    private int stockQuantity;

    @ManyToMany (mappedBy = "items")  // ì˜ˆì œë¥¼ ìœ„í•œ N:N ê´€ê³„
    private List<Category> categories = new ArrayList<>();

    //== ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ==//
    // ì¬ê³ ë¥¼ ì¶”ê°€í•˜ê³  ë‚®ì¶”ëŠ” ë¡œì§ì€ stockQuantity ë°ì´í„°ë§Œ ì‚¬ìš©í•˜ëŠ”ë°
    // ì´ëŸ°ê²½ìš°ëŠ” Service Class ë¥¼ ìƒì„±í•´ setter ë¡œ ì£¼ì…í•˜ëŠ” ê²ƒ ë³´ë‹¤,
    // Entity Class ì— ë¡œì§ì„ ë§Œë“¤ì–´ì„œ í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ëŠ” ê²ƒì´
    // ê°ì²´ì§€í–¥ì ìœ¼ë¡œ ë´¤ì„ ë•Œ ì‘ì§‘ë ¥ë„ ë†’ì•„ì§€ê³  ê´€ë¦¬ì°¨ì›ì—ì„œë„ ìˆ˜ì›”í•˜ë‹¤.

    // !!! ê°•ì˜ì—ì„œëŠ” í¸ì˜ìƒ setter ë¥¼ ìƒì„±í–ˆì§€ë§Œ setter ë¥¼ ë§Œë“¤ì§€ ì•ŠëŠ” ê²ƒì´ ì „ì²´ì ìœ¼ë¡œ ë” ì¢‹ë‹¤.

    /**
     * stock ì¦ê°€
     */
    public void addStock(int quantity) {
        this.stockQuantity += quantity;
    }
    /**
     * stock ê°ì†Œ
     * ì¬ê³ ê°€ ë§ˆì´ë„ˆìŠ¤ê°€ ë˜ë©´ ì•ˆë˜ê¸° ë•Œë¬¸ì— ì²´í¬í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì´ í•„ìš”í•˜ë‹¤.
     */
    public void removeStock(int quantity) {
        int restStock = this.stockQuantity - quantity;
        if (restStock < 0) {
            throw new NotEnoughStockException("need more stock");
        }
        this.stockQuantity = restStock;
    }
}
```
