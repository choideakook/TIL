# DB ì ‘ê·¼ ì˜ˆì™¸ ì§ì ‘ ë§Œë“¤ê¸°

DB ì˜¤ë¥˜ì— ë”°ë¼ì„œ íŠ¹ì • ì˜ˆì™¸ëŠ” Service ê³„ì¸µì—ì„œ ì²˜ë¦¬í•˜ëŠ”ê²ƒì´ ì¢‹ì€ ê²½ìš°ë„ ìˆë‹¤.

ì´ ê²½ìš° ì˜ˆì™¸ ë³µêµ¬í•´ì„œ ì²˜ë¦¬í•´ì•¼ í•˜ëŠ”ë°,
ì´ ì „ ë°©ì‹ì€ ë„˜ì˜¤ì–´ëŠ” ì˜ˆì™¸ë¥¼ êµ¬ë³„í•  ìˆ˜ ì—†ì–´ ë³µêµ¬í•˜ê¸° ì–´ë ¤ìš´ ë‹¨ì ì´ ìˆë‹¤.

<br>

## âœï¸Â DB ì˜¤ë¥˜ ì½”ë“œë¡œ ë¬¸ì œì  í•´ê²°

DB ì˜¤ë¥˜ ì½”ë“œë¥¼ ì´ìš©í•´ ë¬¸ì œì ì„ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

<img width="532" alt="s661" src="https://user-images.githubusercontent.com/115536240/215923077-559c487c-27ee-45c9-990c-7cd0f969a13b.png">

- ID ì¤‘ë³µ ì˜ˆì™¸ë¥¼ Service ì—ì„œ ì²˜ë¦¬í•˜ê³  ì‹¶ì„ ê²½ìš°
- ì¤‘ë³µ ë˜ëŠ” data ë¥¼ SQL ì„ í†µí•´ DB ì— ì „ë‹¬í•œë‹¤.
- DB ëŠ” ì¤‘ë³µì´ ë˜ì–´ ì˜¤ë¥˜ì½”ë“œ 23505 ë¥¼ ë°˜í™˜í•œë‹¤.
    - ì—ëŸ¬ì½”ë“œëŠ” ê´€ê³„í˜• DB ë§ˆë‹¤ ë‹¤ë¥´ë‹¤.
    - 23505 ëŠ” H2 ì˜ í‚¤ ì¤‘ë³µ ì˜¤ë¥˜ì´ë‹¤.
- ë°˜í™˜ëœ ì˜¤ë¥˜ì½”ë“œëŠ” Excption ì— í¬í•¨ë˜ì–´ Service ê¹Œì§€ Throws ëœë‹¤.
- ì „ë‹¬ëœ ì—ëŸ¬ì½”ë“œëŠ” getErrorCode() ë¥¼ í†µí•´ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```java
e.getErrorCode()
// ì¶œë ¥ : 23505
```

[ğŸ”—Â H2 DB ì˜ error code ë¦¬ìŠ¤íŠ¸](https://www.h2database.com/javadoc/org/h2/api/ErrorCode.html)

âš ï¸Â ê´€ê³„í˜• DB ë§ˆë‹¤ ì½”ë“œ ë²ˆí˜¸ê°€ ë‹¤ë¥´ê¸° ë•Œë¬¸ì— ì§ì ‘ ì°¾ì•„ë´ì•¼ í•œë‹¤.

<br>

## âœï¸Â Error code ë¥¼ ì ìš©í•´ ë¬¸ì œ í•´ê²°

### ğŸ“Â Exception ìƒì„±

- MyDbException ì„ ìƒì†í•˜ëŠ” Exception ì„ ìƒì„±í•œë‹¤.
    - MyDbException ì—ì„œ íŒŒìƒëœ ì˜ˆì™¸ë¼ëŠ”ê±¸ í™•ì¸í•˜ê¸° ì‰¬ì›Œì§
    - ì§ì ‘ ë§Œë“  ì˜ˆì™¸ê¸° ë•Œë¬¸ì— íŠ¹ì • ê¸°ìˆ ì— ì¢…ì†ì ì´ì§€ ì•Šë‹¤.
    - í–¥í›„ ë‹¤ë¥¸ ê¸°ìˆ ë¡œ ë°”ê¾¸ë”ë¼ë„ ì˜ˆì™¸ë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€í•  ìˆ˜ ìˆë‹¤.

```java
package hello.jdbc.repository.ex;

// MyDbException ì„ ìƒì†ì‹œí‚¤ë©´ MyDbException ì—ì„œ íŒŒìƒëœ Exception ì¸ê±¸ ì‰½ê²Œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
public class MyDuplicateKeyException extends MyDbException{
    public MyDuplicateKeyException() {
    }

    public MyDuplicateKeyException(String message) {
        super(message);
    }

    public MyDuplicateKeyException(String message, Throwable cause) {
        super(message, cause);
    }

    public MyDuplicateKeyException(Throwable cause) {
        super(cause);
    }
}
```

<br>

### ğŸ“Â Repository

- save ë¡œì§ì„ êµ¬í˜„í–ˆë‹¤.
    - try ì—ì„œ ë°œìƒë˜ëŠ” ì˜ˆì™¸ì¤‘ id ì¤‘ë³µ ì˜ˆì™¸ë§Œ if ë¬¸ì„ í†µí•´ ê³¨ë¼ë‚´ MyDuplicateKeyException ë¡œ ì˜ˆì™¸ë¥¼ ë³€í™˜í–ˆë‹¤.

```java
    @RequiredArgsConstructor
    static class Repository {
        private final DataSource dataSource;

        public Member save(Member member) {
            String sql = "insert into member(member_id, money) values(?,?)";
            Connection con = null;
            PreparedStatement pstmt = null;

            try {
                con = dataSource.getConnection();
                pstmt = con.prepareStatement(sql);
                pstmt.setString(1, member.getMemberId());
                pstmt.setInt(2, member.getMoney());
                pstmt.executeUpdate();
                return member;
            } catch (SQLException e) {
                // H2 db
                // id ì¤‘ë³µ ì˜ˆì™¸ë¥¼ ë³µêµ¬í•˜ëŠ” ë¡œì§
                if (e.getErrorCode() == 23505) {
                    throw new MyDuplicateKeyException(e);
                }
                // id ì¤‘ë³µ ì´ì™¸ì˜ ì˜ˆì™¸ë¥¼ throw í•˜ëŠ” ë¡œì§
                throw new MyDbException(e);
            }finally {
                JdbcUtils.closeStatement(pstmt);
                JdbcUtils.closeConnection(con);
            }
        }
    }
```

<br>

### ğŸ“Â Service

- member ë¥¼ ìƒì„±í•˜ëŠ” Create method ë¥¼ ë§Œë“¤ì—ˆë‹¤.
    - data ë¥¼ ì €ì¥í•  ë•Œ PK ì¸ memberId ê°€ ì¤‘ë³µë  ê²½ìš°ë¥¼ catch ë¡œ ì¡ì•„ë‚¸ë‹¤.
        - repository ì—ì„œ êµ¬ë³„í•´ë‚¸ MyDuplicateKeyException ì„ ì‚¬ìš©í•´ ê³¨ë¼ë‚¼ ìˆ˜ ìˆë‹¤.
        - ê¸°ì¡´ id ë’¤ì— ëœë¤ìˆ«ìë¥¼ ë”í•´ì„œ ìƒˆë¡œìš´ ì•„ì´ë””ë¡œ ë§Œë“œëŠ” ë¡œì§ì´ë‹¤.
    - id ì¤‘ë³µ ì˜ˆì™¸ë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ SQL ì˜ˆì™¸ëŠ” MyDbException ê·¸ëŒ€ë¡œ ë˜ì ¸ì¤€ë‹¤.

```java
    @Slf4j
    @RequiredArgsConstructor
    static class Service{
        private final Repository repository;

        public void create(String memberId) {
            try {
                repository.save(new Member(memberId, 0));
                // save ê°€ ì„±ê³µí• ê²½ìš° ì¶œë ¥ë˜ëŠ” log
                log.info("saveID = {}", memberId);
            } catch (MyDuplicateKeyException e) {
                // id ê°€ ì¤‘ë³µë˜ì–´ ìƒˆë¡œìš´ id ë¡œ ë§Œë“œëŠ” ë¡œì§
                log.info("í‚¤ ì¤‘ë³µ, ë³µêµ¬ ì‹œë„");
                String retryId = generateNewId(memberId);
                // ìƒˆë¡œìš´ id ë¥¼ ì¶œë ¥í•˜ëŠ” log
                log.info("retryId = {}", retryId);
                repository.save(new Member(retryId, 0));
            } catch (MyDbException e) {
                // MyDbException ì€ runtime ì´ë¼ ìƒëµí•´ë„ ê´œì°®ë‹¤.
                log.info("ë°ì–´í„° ì ‘ê·¼ ê³„ì¸µ ì˜ˆì™¸", e);
                throw e;
            }
        }

        // memberId ë’¤ì— Random ìˆ«ìë¥¼ ì¶”ê°€í•˜ëŠ” ë¡œì§
        private String generateNewId(String memberId) {
            return memberId + new Random().nextInt(100);
        }
    }
```

<br>

### ğŸ“Â Test

- DI ë¥¼ í•œí›„ test ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•œë‹¤.

```java
@Slf4j
public class ExTranslatorV1Test {

    Repository repository;
    Service service;

    @BeforeEach
    void init() {
        DriverManagerDataSource dataSource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);
        repository = new Repository(dataSource);
        service = new Service(repository);
    }

    // ì¤‘ë³µ id ë¥¼ ì €ì¥
    @Test
    void duplicateKeySave() {
        service.create("myID");
        service.create("myID");
    }
```

### ğŸ”Â ì¶œë ¥ë¬¼

- ì²«ë²ˆì§¸ id ê°€ ì •ìƒì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆë‹¤.
- ë‘ë²ˆì§¸ id ê°€ ì €ì¥ë˜ì§€ ì•Šì•„ ë³µêµ¬ë¥¼ ì‹œë„í–ˆê³  ìƒˆë¡œìš´ id ë¥¼ ë§Œë“¤ì–´ ì €ì¥ì— ì„±ê³µí–ˆë‹¤.

```java
- saveID = myID

- í‚¤ ì¤‘ë³µ, ë³µêµ¬ ì‹œë„
- retryId = myID1
```

<br>

### ğŸ“Â ë¬¸ì œì 

- ê´€ê³„í˜• DB ë§ˆë‹¤ Error code ê°€ ëª¨ë‘ ë‹¤ë¥´ê¸° ë•Œë¬¸ì— DB ë¥¼ ë‹¤ë¥¸ê²ƒìœ¼ë¡œ ë°”ê¾¸ê²Œ ë˜ë©´ Repository if ë¬¸ì˜ error code ë¥¼ ìˆ˜ì •í•´ì•¼í•œë‹¤.
    - DB ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì˜ˆì™¸ëŠ” ë„ˆë¬´ ë§ê³  ì´ëŸ° ê²½ìš°ë§ˆë‹¤ ìƒˆë¡œìš´ Exception ì„ ë§Œë“œëŠ”ê²ƒì€ í•œê³„ê°€ ìˆë‹¤.
    - ì´ ìƒí™©ì—ì„œ DB ë¥¼ ë³€ê²½í•˜ë©´ error code ë¥¼ í•˜ë‚˜í•˜ë‚˜ ì „ë¶€ ë°”ê¿”ì•¼ í•˜ëŠ” ë¬¸ì œê°€ ìƒê¸´ë‹¤.
