# ì²´í¬ ì˜ˆì™¸ì™€ ì¸í„°í˜ì´ìŠ¤

Service ê³„ì¸µì€ íŠ¹ì • êµ¬í˜„ ê¸°ìˆ ì— ì˜ì¡´í•˜ì§€ ì•Šê³  ìˆœìˆ˜í•˜ê²Œ ìœ ì§€ì‹œí‚¤ê¸° ìœ„í•´ì„œ 

ì˜ˆì™¸ì— ëŒ€í•œ ì˜ì¡´ë„ í•¨ê»˜ í•´ê²°í•´ì•¼ í•œë‹¤.

- Service ê°€ ì²˜ë¦¬í•  ìˆ˜ ì—†ëŠ” ì˜ˆì™¸ë¥¼ Runtime ì˜ˆì™¸ë¡œ ì „í™˜í•´ ì˜ˆì™¸ë¥¼ ë¬´ì‹œí•  ìˆ˜ ìˆê²Œ ë°”ê¿”ì„œ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

## âœï¸Â ì¸í„°í˜ì´ìŠ¤ ë„ì…

Service ê°€ Repository ë¥¼ ì§ì ‘ ì˜ì¡´í•˜ì§€ ì•Šê³  Repository ì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì˜ì¡´í•˜ê²Œ ë³€ê²½í•œë‹¤.

- êµ¬í˜„ ê¸°ìˆ ì„ ë³€ê²½í•˜ê³  ì‹¶ìœ¼ë©´ DI ë¥¼ ì´ìš©í•´ Service ì˜ ì½”ë“œ ë³€ê²½ ì—†ì´ êµ¬í˜„ ê¸°ìˆ ì„ ë³€ê²½ í•  ìˆ˜ ìˆìŒ

<br>

- Repository V3 ë¥¼ êµ¬í˜„ì²´ë¡œí•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ì—ˆë‹¤.
    - êµ¬í˜„ì²´ì˜ Method ì—ì„œ SQLException ì„ ë˜ì¡Œê¸° ë•Œë¬¸ì— ì¸í„°í˜ì´ìŠ¤ Method ë„ ë˜ì €ì•¼ í•œë‹¤.

```java
package hello.jdbc.repository;

import hello.jdbc.domain.Member;
import java.sql.SQLException;

public interface MemberRepositoryEx {

    Member save(Member member) throws SQLException;

    Member findById(String memberId) throws SQLException;

    void update(String memberId, int money) throws SQLException;

    void delete(String memberId) throws SQLException;
}
```

### ğŸ“Â ë¬¸ì œì 

interface ë¥¼ ë§Œë“œëŠ” ì´ìœ ê°€ êµ¬í˜„ê¸°ìˆ ì„ ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ ë³€ê²½í•  ë•Œ ê¸°ì¡´ì½”ë“œë¥¼ ìˆ˜ì •í•˜ì§€ ì•Šê¸° ìœ„í•¨ì¸ë°,
SQLException ì€ JDBC ì— ì˜í•œ ì˜ˆì™¸ì´ë‹¤.

ì¦‰ ë‹¤ë¥¸ ê¸°ìˆ  (ì˜ˆë¥¼ ë“¤ì–´ JPA) ë¡œ ë³€ê²½í•˜ê²Œ ë˜ë©´ ì¸í„°í˜ì´ìŠ¤ì˜ ì˜ˆì™¸ë¥¼ í•˜ë‚˜í•˜ë‚˜ ìˆ˜ì •í•´ì•¼í•˜ëŠ” ë¬¸ì œì ì´ ë°œìƒí•œë‹¤.

<br>

### ğŸ“Â Runtime ì˜ˆì™¸ ë³€í™˜ìœ¼ë¡œ ë¬¸ì œ í•´ê²°

- Runtime Exception ìƒì„±

```java
package hello.jdbc.repository.ex;

// RuntimeException
public class MyDbException extends RuntimeException {
    // ê¸°ë³¸ ìƒì„±ì
    public MyDbException() {}

    // exception message ì¶œë ¥
    public MyDbException(String message) {
        super(message);
    }

    // exception message ì™€ root cause ë‘˜ë‹¤ ì¶œë ¥
    public MyDbException(String message, Throwable cause) {
        super(message, cause);
    }

    // root cause ì¶œë ¥
    public MyDbException(Throwable cause) {
        super(cause);
    }
}
```

<br>

- Repository ìˆ˜ì •
    - Catch ì—ì„œ ê¸°ì¡´ Exception ì„ ìƒˆë¡œ ë§Œë“  Runtime ì˜ˆì™¸ì— ë‹´ì•„ì„œ ë˜ì§
    - ì•ìœ¼ë¡œ Method ë¥¼ í˜¸ì¶œí•  ë•Œ ì˜ˆì™¸ì²˜ë¦¬ ì—†ì´ ì •ìƒì ìœ¼ë¡œ Method ë¥¼ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤.

```java
package hello.jdbc.repository;

import hello.jdbc.connection.DBConnectionUtil;
import hello.jdbc.domain.Member;
import hello.jdbc.repository.ex.MyDbException;
import lombok.extern.slf4j.Slf4j;
import org.springframework.jdbc.datasource.DataSourceUtils;
import org.springframework.jdbc.support.JdbcUtils;

import javax.sql.DataSource;
import java.sql.*;
import java.util.NoSuchElementException;

/**
 * ì˜ˆì™¸ ëˆ„ìˆ˜ ë¬¸ì œ í•´ê²°
 * ì²´í¬ ì˜ˆì™¸ë¥¼ ëŸ°íƒ€ì„ ì˜ˆì™¸ë¡œ ë³€ê²½
 * Member Repository ì¸í„°í˜ì´ìŠ¤ ì‚¬ìš©
 * Throws SQL ì˜ˆì™¸ ì œê±°
 */
@Slf4j
public class MemberRepositoryV4 implements MemberRepository {

    private final DataSource dataSource;
    public MemberRepositoryV4(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    // ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬ì²´í™” í•˜ëŠ” Method ì—ëŠ” Override ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ë”ë¸” ì²´í¬ í•´ì£¼ëŠ”ê²ƒì´ ì¢‹ë‹¤.
    @Override
    public Member save(Member member){ // throws ìƒëµ ê°€ëŠ¥
        String sql = "insert into member(member_id, money) values(?, ?)";
        Connection con = null;
        PreparedStatement pstmt = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1, member.getMemberId());
            pstmt.setInt(2, member.getMoney());
            pstmt.executeUpdate();
            return member;

        } catch (SQLException e) {
            // Runtime Exception ìœ¼ë¡œ ë°”ê¿”ì„œ ë˜ì§
            throw new MyDbException(e);
        }finally {
            close(con, pstmt, null);
        }
    }

    @Override
    public Member findById(String memberId){
        String sql = "select * from member where member_id = ?";
        Connection con = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            con = DBConnectionUtil.getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1, memberId);
            rs = pstmt.executeQuery();

            if (rs.next()) {
                Member member = new Member();
                member.setMemberId(rs.getString("member_id"));
                member.setMoney(rs.getInt("money"));
                return member;
            } else {
                throw new NoSuchElementException("member not found memberId = " + memberId);
            }

        } catch (SQLException e) {
            throw new MyDbException(e);
        }finally {
            close(con, pstmt, rs);
        }
    }

    @Override
    public void update(String memberId, int money){
        String sql = "update member set money=? where member_id=?";
        Connection con = null;
        PreparedStatement pstmt = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setInt(1, money);
            pstmt.setString(2, memberId);

            int resultSize = pstmt.executeUpdate();
            log.info("resultSize={}", resultSize);

        } catch (SQLException e) {
            throw new MyDbException(e);
        }finally {
            close(con, pstmt, null);
        }
    }

    @Override
    public void delete(String memberId){
        String sql = "delete from member where member_id=?";
        Connection con = null;
        PreparedStatement pstmt = null;

        try {
            con = getConnection();
            pstmt = con.prepareStatement(sql);
            pstmt.setString(1, memberId);
            pstmt.executeUpdate();

        } catch (SQLException e) {
            throw  new MyDbException(e);
        } finally {
            close(con, pstmt, null);
        }

    }

    private void close(Connection con, Statement stmt, ResultSet rs) {
        JdbcUtils.closeResultSet(rs);
        JdbcUtils.closeStatement(stmt);
        DataSourceUtils.releaseConnection(con, dataSource);
    }

    private Connection getConnection() throws SQLException {
        Connection con = DataSourceUtils.getConnection(dataSource);
        log.info("get connection = {}, class = {}", con, con.getClass());
        return con;
    }
}
```

<br>

- ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„
    - ê°ì²´ ì§€í–¥ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¹”ë”í•œ ì¸í„°í˜ì´ìŠ¤ê°€ ë˜ì—ˆë‹¤.

```java
package hello.jdbc.repository;

import hello.jdbc.domain.Member;

public interface MemberRepository {

    Member save(Member member);

    Member findById(String memberId);

    void update(String memberId, int money);

    void delete(String memberId);
}
```

<br>

- Service êµ¬í˜„
    - ìˆœìˆ˜í•œ Business ë¡œì§ë§Œ ë‚¨ê³  ê°ì²´ ì§€í–¥ì ì¸ Service ê³„ì¸µì´ ë˜ì—ˆë‹¤.

```java
package hello.jdbc.service;

import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepository;
import hello.jdbc.repository.MemberRepositoryV3;
import lombok.extern.slf4j.Slf4j;
import org.springframework.transaction.annotation.Transactional;

import java.sql.SQLException;

/**
 * ì˜ˆì™¸ ëˆ„ìˆ˜ ë¬¸ì œ í•´ê²°
 * SQL ì˜ˆì™¸ ì œê±°
 * Member Repository ì¸í„°í˜ì´ìŠ¤ì— ì˜ì¡´
 */
@Slf4j
public class MemberServiceV4 {

    private final MemberRepository memberRepository;

    public MemberServiceV4(MemberRepository memberRepository) {
        this.memberRepository = memberRepository;
    }

    // Business logic
    @Transactional
    public void accountTransaction(String fromId, String toId, int money){
        Member fromMember = memberRepository.findById(fromId);
        Member toMember = memberRepository.findById(toId);

        int fromMemberMoney = fromMember.getMoney();
        int toMemberMoney = toMember.getMoney();

        if (fromMemberMoney - money < 0) throw new IllegalStateException("ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");

        memberRepository.update(fromId, fromMemberMoney - money);

        if (toId.equals("ex")) throw new IllegalStateException("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ");

        memberRepository.update(toId, toMemberMoney + money);
    }
}
```

<br>

### ğŸ“Â Test

- Config ë¥¼ ìƒˆë¡œ ë§Œë“  ê°ì²´ë¡œ ë³€ê²½í•´ì£¼ë©´ ì •ìƒì ìœ¼ë¡œ ì˜ ì‘ë™ëœë‹¤.
- Throws ì„ ì–¸ì„ ì§€ìš¸ ìˆ˜ ìˆë‹¤.

```java
package hello.jdbc.service;

import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepository;
import hello.jdbc.repository.MemberRepositoryV4_1;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.aop.support.AopUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.context.annotation.Bean;

import javax.sql.DataSource;
import java.sql.SQLException;

import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.jupiter.api.Assertions.assertThrows;

/**
 * ì˜ˆì™¸ ëˆ„ìˆ˜ ë¬¸ì œ í•´ê²°
 * SQL ì˜ˆì™¸ ì œê±°
 * Member Repository ì¸í„°í˜ì´ìŠ¤ì— ì˜ì¡´
 */
@Slf4j
@SpringBootTest
class MemberServiceV4Test {

    public static final String Member_A = "memberA";
    public static final String Member_B = "memberB";
    public static final String Member_EX = "ex";

    @Autowired private MemberRepository memberRepository;
    @Autowired private MemberServiceV4 memberService;

    @TestConfiguration
    static class TestConfig {

        private final DataSource dataSource;

        public TestConfig(DataSource dataSource) {
            this.dataSource = dataSource;
        }

        @Bean
        MemberRepository memberRepository() {
            return new MemberRepositoryV4_1(dataSource);
        }

        @Bean
        MemberServiceV4 memberService() {
            return new MemberServiceV4(memberRepository());
        }
    }

    @AfterEach
    void afterEach() {
        memberRepository.delete(Member_A);
        memberRepository.delete(Member_B);
        memberRepository.delete(Member_EX);
    }

    @Test
    void AopCheck() {
        log.info("memberService class = {}", memberService.getClass());
        log.info("memberRepository class = {}", memberRepository.getClass());
        // í”„ë¡ì‹œ Class ê°€ ì‚¬ìš©ë˜ì—ˆëŠ”ì§€ ê²€ì¦
        assertThat(AopUtils.isAopProxy(memberService)).isTrue();
        assertThat(AopUtils.isAopProxy(memberRepository)).isFalse();
    }

    @Test
    @DisplayName("ì •ìƒ ì´ì²´")
    void accountTransaction() {
        Member memberA = new Member(Member_A, 10000);
        Member memberB = new Member(Member_B, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberB);

        memberService.accountTransaction(memberA.getMemberId(), memberB.getMemberId(), 2000);

        Member findA = memberRepository.findById(memberA.getMemberId());
        Member findB = memberRepository.findById(memberB.getMemberId());

        assertThat(findA.getMoney()).isEqualTo(8000);
        assertThat(findB.getMoney()).isEqualTo(12000);
    }
    @Test
    @DisplayName("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ")
    void accountTransferEx() {
        Member memberA = new Member(Member_A, 10000);
        Member memberB = new Member(Member_EX, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberB);

        assertThrows(IllegalStateException.class,
            ()->memberService.accountTransaction(
                    memberA.getMemberId(), memberB.getMemberId(), 2000));

        Member findA = memberRepository.findById(memberA.getMemberId());
        Member findB = memberRepository.findById(memberB.getMemberId());

        assertThat(findA.getMoney()).isEqualTo(10000);
        assertThat(findB.getMoney()).isEqualTo(10000);
    }
}
```

<br>

### ğŸ“Â ë‚¨ì€ ë¬¸ì œì 

Repository ì—ì„œ ë„˜ì–´ì˜¤ëŠ” íŠ¹ì •í•œ ì˜ˆì™¸ì˜ ê²½ìš° ë³µêµ¬ë¥¼ ì‹œë„í•  ìˆ˜ë„ ìˆë‹¤.

- ì˜ˆë¥¼ ë“¤ì–´ íšŒì›ê°€ì…ì—ì„œ id ê°€ ì¤‘ë³µì¼ ê²½ìš°

ì´ëŸ° ê²½ìš°ëŠ” Service ê³„ì¸µì—ì„œ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•˜ì§€ë§Œ ì§€ê¸ˆ ë°©ì‹ì€ MyDbException ì´ë¼ëŠ” ì˜ˆì™¸ë§Œ ë„˜ì–´ì˜¤ê¸° ë•Œë¬¸ì— ì˜ˆì™¸ë¥¼ êµ¬ë¶„í•  ìˆ˜ ì—†ê²Œëœë‹¤.