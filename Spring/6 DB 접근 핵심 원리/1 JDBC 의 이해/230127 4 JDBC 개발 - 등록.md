# JDBC ê°œë°œ - ë“±ë¡

JDBC ë¥¼ ì‚¬ìš©í•´ì„œ íšŒì› ë°ì´í„°ë¥¼ DB ì— ê´€ë¦¬í•˜ëŠ” ê¸°ëŠ¥ì„ ê°œë°œí•  ê³„íšì´ë‹¤.

<br>

## âœï¸Â Data Insert í•˜ê¸°

- Statememt : SQL ë¬¸ì„ ê·¸ëŒ€ë¡œ ë³´ë‚´ëŠ” ê¸°ëŠ¥
- PreparedStatement : SQL ë¬¸ì— ë°”ì¸ë”©ì´ í•„ìš”í•  ê²½ìš° ì‚¬ìš©í•˜ëŠ” ê¸°ëŠ¥
    - Statememt ë¥¼ ìƒì† ë°›ì•˜ë‹¤.
- data ë¥¼ ë“±ë¡í•  ë• pstmt.executeUpdate() ë¥¼ ì‚¬ìš©í•œë‹¤.

```java
package hello.jdbc.repository;

import hello.jdbc.connection.DBConnectionUtil;
import hello.jdbc.domain.Member;
import lombok.extern.slf4j.Slf4j;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.SQLException;

/**
 * JDBC - DriverManager ë¥¼ ì‚¬ìš©í•˜ê¸°
 */
@Slf4j
public class MemberRepositoryV0 {

    // ì‹¤íŒ¨í• ê²½ìš° ë°œìƒí•  error ë¥¼ ë°–ìœ¼ë¡œ throw
    public Member save(Member member) throws SQLException {
        // í•„ìš”í•œ ìì›ì„ ìƒì„±
        String sql = "insert into member(member_id, money) values (?, ?)";
        Connection con = null;
        PreparedStatement pstmt = null;

        // DB ì™€ ì—°ê²°í•˜ê³  data ë¥¼ ì¶”ê°€
        try {
            // Connection íšë“ (DB ì—°ê²°)
            con = getConnection();
            // Query ìƒì„±
            pstmt = con.prepareStatement(sql);
            // sql ì˜ values ì˜ parameter ìˆœì„œë¥¼ ì ê³  ê·¸ ìˆœì„œì— ë“¤ì–´ê°ˆ ê°’ì„ ì‘ì„±í•˜ë©´ë¨
            pstmt.setString(1, member.getMemberId());
            pstmt.setInt(2, member.getMoney());
            // SQL ì‹¤í–‰
            pstmt.executeUpdate();
            return member;
        } catch (SQLException e) {
            // ì˜ˆì™¸ê°€ ë°œìƒí•  ê²½ìš° ì—ëŸ¬ëŒ€ì‹  ë¡œê·¸ë¥¼ ë‚¨ê¹€
            log.error("db error", e);
            // error ëŠ” ë°–ìœ¼ë¡œ Throw
            throw e;
        }finally {
            // ë¦¬ì†ŒìŠ¤ ì •ë¦¬
            // ë§ˆì§€ë§‰ìœ¼ë¡œ Connection ì„ ë‹«ì•„ì¤€ë‹¤.
            // ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ì™€ì˜ ì—°ê²°ì´ê¸° ë•Œë¬¸ì— ìˆ˜ë™ìœ¼ë¡œ ë‹«ì•„ì£¼ì§€ ì•Šìœ¼ë©´ ì»¤ë„¥ì…˜ ë¶€ì¡± ì¥ì• ê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ
            con.close();
            pstmt.close();
        }
    }

    private static Connection getConnection() {
        return DBConnectionUtil.getConnection();
    }
}
```

â—ï¸ ë§Œì•½ finally ì˜ con.close() ì—ì„œ Exception ì´ ë°œìƒí•  ê²½ìš° pstmt.close() ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ” ë¬¸ì œì ì´ ìƒê¸´ë‹¤.

### ğŸ“Â if ë¬¸ìœ¼ë¡œ ë¬¸ì œ í•´ê²°

- PreparedStatement ëŠ” Statement ë¥¼ ìƒì†ë°›ì•˜ê¸° ë•Œë¬¸ì— Statement ë¡œ í•´ë„ ê´œì°®ë‹¤.
- ResultSet ì€ DB ì‘ë‹µ ê²°ê³¼ë¥¼ ì¡°íšŒí•  ë•Œ ì‚¬ìš©í•˜ëŠ” ê¸°ëŠ¥ì´ë‹¤.
    - ì§€ê¸ˆì€ data ë“±ë¡ì´ë¼ ì‚¬ìš©í•˜ì§€ ì•Šì•˜ë‹¤.
    - [ğŸ”—Â ResultSet](https://github.com/choideakook/TIL/blob/main/Spring/6%20DB%20ì ‘ê·¼%20í•µì‹¬%20ì›ë¦¬/1%20JDBC%20ì˜%20ì´í•´/230127%205%20JDBC%20ê°œë°œ%20-%20ì¡°íšŒ.md)

```java
    }finally {
            // ë¦¬ì†ŒìŠ¤ ì •ë¦¬
            close(con, pstmt, null);
        }
    }
    // ë¦¬ì†ŒìŠ¤ë¥¼ ì •ë¦¬í•  ë•ŒëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•œ ì—­ìˆœìœ¼ë¡œ ì¢…ë£Œí•´ì£¼ì–´ì•¼ í•œë‹¤.
    // rs -> pstmt -> con
    private void close(Connection con, Statement stmt, ResultSet rs) {
        if (rs != null) {
            try {
                rs.close();
            } catch (SQLException e) {
                log.info("error", e);
            }
        }
        if (stmt != null) {
            try {
                stmt.close();
            } catch (SQLException e) {
                log.info("error", e);
            }
        }
        if (con != null) {
            try {
                con.close();
            } catch (SQLException e) {
                log.info("error", e);
            }
        }

    }
```

<br>

## âœï¸Â Test

- Test case ë¥¼ ìƒì„±í•´ data ë¥¼ ë“±ë¡í›„ H2 ì— ì œëŒ€ë¡œ ë“±ë¡ì´ ë¬ëŠ”ì§€ í™•ì¸

```java
package hello.jdbc.repository;

import hello.jdbc.domain.Member;
import org.junit.jupiter.api.Test;

import java.sql.SQLException;

class MemberRepositoryV0Test {

    MemberRepositoryV0 repository = new MemberRepositoryV0();

    @Test
    void crud() throws SQLException {
        Member member = new Member("memberV0", 10000);
        repository.save(member);
    }
}
```

DB ì— ì •ìƒì ìœ¼ë¡œ ë“±ë¡ì´ ë˜ì—ˆë‹¤.

â—ï¸ ì—¬ê¸°ì„œ í•œë²ˆ ë” ì‹¤í–‰í•  ê²½ìš° PK ê°€ ê²¹ì²˜ì„œ error ê°€ ë°œìƒí•˜ê²Œ ëœë‹¤.

- member_id = PK
