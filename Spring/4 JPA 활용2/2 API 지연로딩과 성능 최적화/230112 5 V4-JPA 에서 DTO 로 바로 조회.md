# V4-JPA ì—ì„œ DTO ë¡œ ë°”ë¡œ ì¡°íšŒ

## âœï¸Â Â ì§€ì—° ë¡œë”©ê³¼ ì¡°íšŒ ì„±ëŠ¥ ìµœì í™” 04

- Entity ë¥¼ ì¡°íšŒí•˜ì§€ ì•Šê³  ë°”ë¡œ JPA ì—ì„œ DTO ë¥¼ í†µí•´ ì¡°íšŒí•˜ëŠ” ë°©ë²•

<br>

### ğŸ“Â repository package ì— DTO Class ìƒì„±

ì‚¬ì‹¤ìƒ ì¡°íšŒí•´ì•¼í•˜ëŠ” ëª©ë¡ì´ ë‹¤ë¥´ì§€ ì•Šì•„ ì´ì „ì— ì‚¬ìš©í•˜ë˜ DTO ë¥¼ ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ì„œ ì‚¬ìš©í–ˆë‹¤.

- ìƒì„±ìë§Œ ìƒì„±ì ì£¼ì… ë°©ì‹ìœ¼ë¡œ ë°”ê¾¸ì–´ ì¤¬ë‹¤.

```java
package jpabook.jpashop.repository;

import jpabook.jpashop.domain.Address;
import jpabook.jpashop.domain.OrderStatus;
import lombok.Data;

import java.time.LocalDateTime;

    @Data
    public class OrderSimpleQueryDto {
        private Long orderId;
        private String name;
        private LocalDateTime orderDate;
        private OrderStatus orderStatus;

        private Address address;

        // JPA ê°€ DTO ì— ê°’ì„ ë„£ì–´ì£¼ê¸°ìœ„í•´ ìƒì„±ì ì£¼ì…ë°©ì‹ìœ¼ë¡œ ë³€ê²½
        public OrderSimpleQueryDto(Long id, String name, LocalDateTime orderDate, OrderStatus orderStatus, Address address) {
            this.orderId = id;
            this.name = name;
            this.orderDate = orderDate;
            this.orderStatus = orderStatus;
            this.address = address;
        }

    }
```

<br>

### ğŸ“Â OrderRepository ì— ì¿¼ë¦¬ method ë§Œë“¤ê¸°

- Entiity ë‚˜ value Object ì˜ ê²½ìš°ëŠ” select ë¡œ ë°”ë¡œ ë°˜í™˜í•  ìˆ˜ ìˆì§€ë§Œ DTO ëŠ” ì´ ë°©ë²•ìœ¼ë¡œëŠ” Mapping ì´ ì•ˆëœë‹¤.
    - DTO ë¥¼ mapping í•˜ê¸° ìœ„í•´ì„œëŠ” new Operation ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

```java
// jpa ì—ì„œ dto ë¡œ ë°”ë¡œ ì¡°íšŒí•˜ê¸° ìœ„í•œ ì¿¼ë¦¬ë¬¸
    public List<OrderSimpleQueryDto> findOrderDtos() {
        return em.createQuery(  // select new DTOê²½ë¡œ(ìƒì„±ì íŒŒë¼ë¯¸í„°ê°’)
                "select new jpabook.jpashop.repository.OrderSimpleQueryDto(o.id, m.name, o.orderDate, o.status, d.address)" +
                        " from Order o" +
                        " join o.member m" +
                        " join o.delivery d", OrderSimpleQueryDto.class)
                .getResultList();
    }
```

<br>

### ğŸ“Â Controller Method ì™„ì„±

```java
    // Entity ë¥¼ ê±°ì¹˜ì§€ì•Šê³  JPA ì—ì„œ DTO ë¥¼ í†µí•´ ì¡°íšŒí•˜ëŠ” ë°©ë²•
    @GetMapping("/api/v4/simple-orders")
    public List<OrderSimpleQueryDto> ordersV4() {
        return orderRepository.findOrderDtos();
    }
```

<br>

### ğŸ”Â ì¶œë ¥ë¬¼ í™•ì¸

Repository ì—ì„œ í•„ìš”í•œ data ë§Œ select í•´ì„œ ì¿¼ë¦¬ë¬¸ì„ ë§Œë“¤ì—ˆê¸° ë•Œë¬¸ì— V3 ë³´ë‹¤ ì¿¼ë¦¬ë¬¸ì´ ì§§ì•„ì§€ê³  íš¨ìœ¨ì´ ë§ì´ ìƒìŠ¹í–ˆë‹¤.

```java
    select
        order0_.order_id as col_0_0_,
        member1_.name as col_1_0_,
        order0_.order_date as col_2_0_,
        order0_.status as col_3_0_,
        delivery2_.city as col_4_0_,
        delivery2_.street as col_4_1_,
        delivery2_.zipcode as col_4_2_ 
    from
        orders order0_ 
    inner join
        member member1_ 
            on order0_.member_id=member1_.member_id 
    inner join
        delivery delivery2_ 
            on order0_.delivery_id=delivery2_.delivery_id
```

<br>

### ğŸ“ë¬¸ì œì 

repository ëŠ” Entity ë¥¼ ì¡°íšŒí•˜ëŠ” ìš©ë„ë¡œ ì‚¬ìš©í•´ì•¼í•˜ì§€ë§Œ V4 ë°©ì‹ì€ DTO ë¥¼ ì¡°íšŒí•˜ëŠ” ë°©ì‹ì´ê¸° ë•Œë¬¸ì— ìœ„ì¹˜ì ìœ¼ë¡œ ì í•©í•˜ì§€ ì•Šë‹¤

- findOrderDtos Method ì˜ ìœ„ì¹˜ë¥¼ ì˜®ê²¨ì„œ í•´ê²°
    - reposiory ë‚´ì˜ order package ë¥¼ ë§Œë“¤ê³  ì¿¼ë¦¬ìš© package ë¥¼ ë³„ë„ë¡œ ë§Œë“¤ì–´ì¤€ë‹¤.
    - repository ë‚´ì˜ Order ê´€ë ¨ íŒŒì¼ë“¤ì€ order package ì— , ì¿¼ë¦¬ ê´€ë ¨ íŒŒì¼ì€ ì¿¼ë¦¬ìš© package ì— ë„£ì–´ë‘”ë‹¤.

```java
package jpabook.jpashop.repository.order.simplequery;

import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

import javax.persistence.EntityManager;
import java.util.List;

@Repository
@RequiredArgsConstructor
public class OrderSimpleQueryRepository {

    private final EntityManager em;

    // jpa ì—ì„œ dto ë¡œ ë°”ë¡œ ì¡°íšŒí•˜ê¸° ìœ„í•œ ì¿¼ë¦¬ë¬¸
    public List<OrderSimpleQueryDto> findOrderDtos() {
        return em.createQuery(
                        "select new jpabook.jpashop.repository.order.simplequery.OrderSimpleQueryDto(o.id, m.name, o.orderDate, o.orderStatus, d.address)" +
                                " from Order o" +
                                " join o.member m" +
                                " join o.delivery d", OrderSimpleQueryDto.class)
                .getResultList();
    }
}
```

OrderSimpleQueryDto ë„ ê°™ì€ ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•´ì£¼ì—ˆë‹¤.

<br>

Controller ë„ ë³€ê²½

```java
// ì˜ì¡´ ê´€ê³„ ì¶”ê°€
private final OrderSimpleQueryRepository orderSimpleQueryRepository;

// ìƒˆë¡œìš´ ì˜ì¡´ê´€ê³„ë¡œ í´ë ˆìŠ¤ í˜¸ì¶œì„ ë³€ê²½í•´ì¤Œ
@GetMapping("/api/v4/simple-orders")
public List<OrderSimpleQueryDto> ordersV4() {
    return orderSimpleQueryRepository.findOrderDtos();
}
```

ì´ë ‡ê²Œ ë˜ë©´ Order Repository ëŠ” ëª©ì ì— ë§ê²Œ ìˆœìˆ˜í•œ Entity ì¡°íšŒë§Œ í•  ìˆ˜ ìˆê²Œëœë‹¤.

<br>

â—ï¸ ê·¸ëŸ¼ V4 ë°©ì‹ì´ V3 ë°©ì‹ë³´ë‹¤ ì¢‹ì€ ë°©ì‹ì¼ê¹Œ?

<br>

## âœï¸Â V3 ë°©ì‹ê³¼ V4 ë°©ì‹ì˜ ì¥ë‹¨ì 

### 1. ë²”ìš©ì„±

- V3
    - Entity ê·¸ë¦¬ê³  Entity ì™€ ì—°ê´€ëœ ë‹¤ë¥¸ Entity ì˜ ì •ë³´ë¥¼ ëª¨ë‘ ê°€ì ¸ì™€ DTO ë¡œ í•„ìš”í•œ ë§Œí¼ ê³¨ë¼ì„œ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ë‹¤ë¥¸ API ì—ì„œë„ ì¬í™œìš©í•´ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ ë²”ìš©ì„±ì´ ì¢‹ë‹¤.
- V4
    - íŠ¹ì • API ê°€ ì›í•˜ëŠ” ì •ë³´ë¥¼ í•í•˜ê²Œ DTO ë¡œ ë§Œë“¤ì–´ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ë‹¤ë¥¸ API ì—ì„œ ì‚¬ìš©í•˜ê¸° ì–´ë ¤ì›Œì§„ë‹¤.

### 2. ì¬í™œìš© ê°€ëŠ¥ì„±

- V3
    - Entity ë¥¼ ê°€ì ¸ì˜¨ v3 ëŠ” Service ë‹¨ê³„ì—ì„œ ì´ë¥¼ í™œìš©í•´ ë‹¤ì–‘í•œ ë¡œì§ì„ ë§Œë“¤ ìˆ˜ ìˆì–´ ë‹¤ì–‘í•œ ë°©ì‹ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤.
- V4
    - Entity ë¥¼ ê±°ì¹˜ì§€ ì•Šê³  DTO ë¡œ ë°”ë¡œ ì¡°íšŒí–ˆê¸° ë•Œë¬¸ì— ë³€ê²½ ê¶Œí•œì´ ì—†ì–´ ë‹¤ë¥¸ ìš©ë„ë¡œ ì‚¬ìš©ì´ ì œí•œì ì´ë‹¤.

### 3. ìµœì í™”

- V3
    - Entity ì˜ data ë¥¼ ì¼ë‹¨ ëª¨ë‘ ê°€ì ¸ì˜¤ê¸° ë•Œë¬¸ì— ë„¤íŠ¸ì›Œí¬ ìš©ëŸ‰ì— ì•„ì£¼ ì•½ê°„ì˜ ë‚­ë¹„ê°€ ìƒê¸´ë‹¤.
- V4
    - íŠ¹ì • API ê°€ ì›í•˜ëŠ” ì •ë³´ë§Œ í•í•˜ê²Œ ì¡°íšŒí•˜ê¸° ë•Œë¬¸ì— ë„¤íŠ¸ì›Œí¬ ìš©ëŸ‰ ë©´ì—ì„œ ìµœì í™” ë¬ë‹¤.
    - êµ‰ì¥íˆ ë¬´ê±°ìš´ í†µê³„í˜• Api ë¥¼ ë§Œë“¤ì–´ì•¼ í• ë•Œ V3 ë³´ë‹¤ ìš°ìˆ˜í•˜ê²Œ ì œì‘ í•  ìˆ˜ ìˆë‹¤.

### ğŸ“Â ê²°ë¡ 

1. ê¸°ë³¸ì ìœ¼ë¡œ Entity ë¥¼ DTO ë¡œ ë³€í™˜í•˜ëŠ” ë°©ë²• (V2) ë¥¼ ì„ íƒí•œë‹¤.
2. í•„ìš”ì‹œ Fetch join ìœ¼ë¡œ ì„±ëŠ¥ì„ ìµœì í™” í•œë‹¤. (V3)
    - ëŒ€ë¶€ë¶„ì˜ ì„±ëŠ¥ ì´ìŠˆê°€ í•´ê²°ë¨
3. ê·¸ë˜ë„ ì„±ëŠ¥ ì´ìŠˆê°€ ë‚˜íƒ€ë‚ ê²½ìš° DTO ë¡œ ì§ì ‘ ì¡°íšŒí•˜ëŠ” ë°©ë²• (V4) ì„ ì‚¬ìš©í•œë‹¤.
4. ìµœí›„ì˜ ë°©ë²•ì€ JPA ê°€ ì œê³µí•˜ëŠ” ë„¤ì´í‹°ë¸Œ SQL ì´ë‚˜ Spring JDBC Template ë¥¼ ì‚¬ìš©í•´ SQL ì„ ì§ì ‘ ì‚¬ìš©í•´ì•¼í•œë‹¤.