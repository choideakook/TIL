# V3.1-Paging í•œê³„ëŒíŒŒ

## âœï¸Â Collection ì¡°íšŒ ìµœì í™” 04

- Collection fetch join ì˜ ë¬¸ì œ í•´ê²°ë°©ë²•
    - ~ : 1 ì¦‰ @ManyToOne , @OneToOne ê´€ê³„ëŠ” ì•„ë¬´ë¦¬ ë§ì•„ë„ Fetch Join ìœ¼ë¡œ data ë¥¼ ê°€ì ¸ì™€ë„ ëœë‹¤.
    - Collection ì¦‰ @OneToMany ëŠ” ì§€ì—° ë¡œë”©ìœ¼ë¡œ ì¡°íšŒí•œë‹¤.
    - ì§€ì—° ë¡œë”© ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ hibernate.default_batch_fetch_size , @BatchSize ë¥¼ ì ìš©í•œë‹¤.

### ğŸ“Â Collection ì€ ì§€ì—°ë¡œë”©ìœ¼ë¡œ ì‹¤í–‰í•˜ëŠ” ë°©ë²•

ì´ ë°©ë²•ìœ¼ë¡œ ì§„í–‰í•  ê²½ìš° V2 ì²˜ëŸ¼ Collection ì— ëŒ€í•´ data ê°€ ì¤€ë¹„ë˜ì–´ìˆì§€ ì•Šìœ¼ë¯€ë¡œ í•„ìš”í•œ ì •ë³´ë§Œ í•˜ë‚˜ì”© í•˜ë‚˜ì”© ì¿¼ë¦¬ë¬¸ì„ ìƒì„±í•´ ì¡°íšŒí•˜ê²Œ ëœë‹¤.

- Collection ì¸ OrderItem ê³¼ Item ì„ ì œì™¸í•œ data ë§Œ ì¡°íšŒí•´ì˜´

```java
public List<Order> findAllWithMemberDelivery() {
        return em.createQuery(
                "select o from Order o" +
                        " join fetch o.member m" +
                        " join fetch o.delivery d", Order.class
        ).getResultList();
    }
```

ì´ë ‡ê²Œ í•˜ë©´ í˜ì´ì§•ì´ ë‹¤ì‹œ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ê²Œ ëœë‹¤.

```java
// í˜ì´ì§• ê¸°ëŠ¥ ì¶”ê°€
public List<Order> findAllWithMemberDelivery(int offset, int limit) {
    return em.createQuery(
                "select o from Order o" +
                " join fetch o.member m" +
                " join fetch o.delivery d", Order.class)
            .setFirstResult(offset)
            .setMaxResults(limit)
            .getResultList();
    }
```

Controller ë„ ìˆ˜ì •

- @RequestParam - url ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì–´ë…¸í…Œì´ì…˜

```java
//V3.1 V3 ì˜ ë¬¸ì œì ì„ ë³´ì™„
    @GetMapping("/api/v3.1/orders")
    public List<OrderDto> orderV3_page(
            @RequestParam(value = "offset", defaultValue = "0") int offset,
            @RequestParam(value = "limit", defaultValue = "100") int limit
    ) {
        return orderRepository.findAllWithMemberDelivery(offset, limit).stream()
                .map(o -> new OrderDto(o))
                .collect(Collectors.toList());
    }
```

### ğŸ”Â ì¶œë ¥ë¬¼ í™•ì¸

- url : http://localhost:8080/api/v3.1/orders?offset=1&limit=100
    - Parameter ë¥¼ ë§Œë“¤ì—ˆìœ¼ë¯€ë¡œ url ì—ì„œ Parameter ê°’ì„ ì…ë ¥í•´ ì¤˜ì•¼í•œë‹¤.
        - offset = 1 , limit = 100
- ì²«ë²ˆì§¸ data ê°€ 0 ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ ì´ 2ê°œì˜ data ì¤‘ ë‘ë²ˆì§¸ data í•˜ë‚˜ë§Œ ë‚˜ì•¼ ì„±ê³µ
    - ì •ìƒì ìœ¼ë¡œ ì‘ë™í–ˆë‹¤.

```java
[
    {
        "orderId": 11,
        "name": "userB",
        "orderDate": "2023-01-13T14:16:40.409733",
        "address": {
            "city": "ì „ì£¼",
            "street": "2",
            "zipcode": "2222"
        },
        "orderStatus": "ORDER",
        "orderItems": [
            {
                "itemName": "SPRING1 BOOK",
                "orderPrice": 20000,
                "count": 2
            },
            {
                "itemName": "SPRING2 BOOK",
                "orderPrice": 40000,
                "count": 4
            }
        ]
    }
]
```

ì›í•˜ëŠ” ê²°ê³¼ê°’ë„ ì–»ì—ˆê³  í˜ì´ì§•ë„ ì •ìƒì ìœ¼ë¡œ ì‘ë™ë˜ì§€ë§Œ Query ë¬¸ì´ ë§ì´ í•„ìš”í•œ ë°©ë²•ì´ê¸° ë•Œë¬¸ì— data ê°€ ë§ë‹¤ë©´ ì„±ëŠ¥ì´ ë‚®ì•„ì§ˆ ìˆ˜ ë°–ì— ì—†ë‹¤.

<br>

## âœï¸Â hibernate.default_batch_fetch_size

fetch ë¡œ ë¯¸ë¦¬ ì¤€ë¹„í•˜ì§€ ì•Šì€ data (Collection) ì¼ ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œ í•„ìš”í•œ data ë§Œ í•˜ë‚˜ì”© ì¿¼ë¦¬ë¬¸ìœ¼ë¡œ ì¡°íšŒí–ˆì§€ë§Œ,

hibernate.default_batch_fetch_size ë¡œ í•„ìš”í•œ data ë¥¼ ì¡°íšŒí•  ë•Œ ì¡°íšŒí•  ê°¯ìˆ˜ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë‹¤.

- application.yml ì—ì„œ ë³€ê²½ê°€ëŠ¥

```java
jpa:
    hibernate:
      ddl-auto: create
    properties:
      hibernate:
        format_sql: true
				// í•„ìš”í•  ë•Œ ë§ˆë‹¤ í•˜ë‚˜ì”© ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ë‹ˆê¹Œ ê¸°ë³¸ê°’ì´ 1 ì´ê³ 
				// 10 ìœ¼ë¡œ ë°”ê¿”ì¤„ ê²½ìš° í•œë²ˆì— 10ê°œì˜ data ë¥¼ ì¡°íšŒí•˜ëŠ” Query ë¬¸ì„ ìƒì„±í•˜ê²Œëœë‹¤,
        default_batch_fetch_size: 10
```

### ğŸ”Â ì¶œë ¥ë¬¼ í™•ì¸

ì´ 3ë²ˆì˜ Query ë¬¸ìœ¼ë¡œ ì›í•˜ëŠ” data ê°€ ì •ìƒì ìœ¼ë¡œ ì¶œë ¥ë˜ì—ˆë‹¤.

- ì§ì ‘ ë§Œë“  fetch join ì¿¼ë¦¬ë¬¸
- OrderItem ì„ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ë¬¸
- Item ì„ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ë¬¸

```java
    // ì§ì ‘ ë§Œë“  fetch join ì¿¼ë¦¬ë¬¸
    select
        order0_.order_id as order_id1_6_0_,
        member1_.member_id as member_i1_4_1_,
        delivery2_.delivery_id as delivery1_2_2_,
        order0_.delivery_id as delivery4_6_0_,
        order0_.member_id as member_i5_6_0_,
        order0_.order_date as order_da2_6_0_,
        order0_.status as status3_6_0_,
        member1_.city as city2_4_1_,
        member1_.street as street3_4_1_,
        member1_.zipcode as zipcode4_4_1_,
        member1_.name as name5_4_1_,
        delivery2_.city as city2_2_2_,
        delivery2_.street as street3_2_2_,
        delivery2_.zipcode as zipcode4_2_2_,
        delivery2_.status as status5_2_2_ 
    from
        orders order0_ 
    inner join
        member member1_ 
            on order0_.member_id=member1_.member_id 
    inner join
        delivery delivery2_ 
            on order0_.delivery_id=delivery2_.delivery_id limit ?
//OrderItem ì„ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ë¬¸
select
        orderitems0_.order_id as order_id5_5_1_,
        orderitems0_.order_item_id as order_it1_5_1_,
        orderitems0_.order_item_id as order_it1_5_0_,
        orderitems0_.count as count2_5_0_,
        orderitems0_.item_id as item_id4_5_0_,
        orderitems0_.order_id as order_id5_5_0_,
        orderitems0_.order_price as order_pr3_5_0_ 
    from
        order_item orderitems0_ 
    where
        orderitems0_.order_id in (
            ?, ?
        )
// Item ì„ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ë¬¸
select
        item0_.item_id as item_id2_3_0_,
        item0_.name as name3_3_0_,
        item0_.price as price4_3_0_,
        item0_.stock_quantity as stock_qu5_3_0_,
        item0_.artist as artist6_3_0_,
        item0_.etc as etc7_3_0_,
        item0_.author as author8_3_0_,
        item0_.isbn as isbn9_3_0_,
        item0_.actor as actor10_3_0_,
        item0_.director as directo11_3_0_,
        item0_.dtype as dtype1_3_0_ 
    from
        item item0_ 
    where
        item0_.item_id in (
            ?, ?, ?, ?
        )
```

<br>

## âœï¸Â @BatchSize

hibernate.default_batch_fetch_size ê°€ project ì˜ ëª¨ë“  Entity ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì ìš©ë¬ë‹¤ë©´ @BatchSize ëŠ” íŠ¹ì • í•„ë“œë‚˜ Class ë§Œ ì„ íƒì ìœ¼ë¡œ ì ìš©í•  ìˆ˜ ìˆë‹¤.

- Collection í•„ë“œì— ì ìš©í•  ê²½ìš°
    - orderItems ë¥¼ ì¡°íšŒí•  ë•Œë§Œ 100 ê°œì”© ì¡°íšŒí•˜ëŠ” Query ë¬¸ ìƒì„±

```java
// í•œë²ˆì— 100ê°œì˜ data ë¥¼ ì¡°íšŒí•˜ëŠ” query ë¬¸ ìƒì„±
@BatchSize (size = 100)
@OneToMany (mappedBy = "order" , cascade = CascadeType.ALL)
private List<OrderItem> orderItems = new ArrayList<>();
```

- ~ : 1 ê´€ê³„ì˜ í•„ë“œì— ì ìš©í•  ê²½ìš°
    - ì´ ê²½ìš°ëŠ” í•„ë“œ ë§ê³  Class ì— ì–´ë…¸í…Œì´ì…˜ì„ ë„£ì–´ì£¼ë©´ ëœë‹¤.

```java
@BatchSize (size = 100)
@Entity
@Table (name = "orders")
@Getter @Setter
@NoArgsConstructor (access = AccessLevel.PROTECTED)
public class Order {
```

## âœï¸Â V3 ë°©ì‹ê³¼ì˜ ë¹„êµ

distinct ë¥¼ ì´ìš©í•œ V3 ì™€ ì§€ì—°ë¡œë”©ì„ ì´ìš©í•œ V3.1 ë‘˜ ë‹¤ ìµœì¢…ì ìœ¼ë¡œ ë˜‘ê°™ì€ ê²°ê³¼ë¥¼ ì¶œë ¥í•˜ì§€ë§Œ ë‚´ë¶€ì ì¸ ì°¨ì´ê°€ ìˆë‹¤.

- V3
    - ì‹¤ì§ˆì ìœ¼ë¡œ DB ì—ì„œ Application ìœ¼ë¡œ data ê°€ ë„˜ì–´ì˜¬ ë•Œ ì¤‘ë³µì´ ì œê±°ë˜ì§€ ì•Šì€ ìƒíƒœë¡œ ë„˜ì–´ì˜¨ ì´í›„ì— distinct ë¡œ ì¤‘ë³µì„ ì œê±°í•´ì„œ ì¶œë ¥í•˜ê¸° ë•Œë¬¸ì— data ê°€ í´ìˆ˜ë¡ ì¤‘ë³µìœ¼ë¡œ ì¸í•´ ì„±ëŠ¥ì´ ë‚®ì•„ì§€ê²Œëœë‹¤.
    - í˜ì´ì§•ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤.
- V3.1
    - í•„ìš”í•œ data ë§Œ ê°ê°ì˜ Query ë¬¸ì„ ë§Œë“¤ì–´ì•¼ë˜ì„œ V3 ë³´ë‹¤ ë§ì€ Query ë¬¸ì´ í•„ìš”í•˜ì§€ë§Œ, êº¼ë‚´ì„œ ì¡°í•©í•´ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì´ë¯€ë¡œ ì¤‘ë³µì„ ì™„ë²½í•˜ê²Œ ì œì™¸í•œ í›„ Application ìœ¼ë¡œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆê²Œëœë‹¤.
    - í˜ì´ì§•ì´ ê°€ëŠ¥í•˜ë‹¤.