# V4-JPA ì—ì„œ DTO ë¡œ ì§ì ‘ ì¡°íšŒ

## âœï¸Â Collection ì¡°íšŒ ìµœì í™” 05

ê¸°ì¡´ì— ì‚¬ìš©ì¤‘ì¸ OrderRepository ëŠ” Entity ë¥¼ ì¡°íšŒí•˜ëŠ” ìš©ë„ê¸° ë•Œë¬¸ì— í™”ë©´ API ì— ì˜ì¡´ê´€ê³„ê°€ ìˆëŠ” package ë¥¼ ìƒì„±í•´ ë³´ê´€í•´ì£¼ë©´ ìœ ì§€ë³´ìˆ˜ ê´€ì ì—ì„œ ê°œì„ ì´ ëœë‹¤.

### ğŸ“Â ë¡œì§ ê°œë°œí•˜ê¸°

1. Order ì—ì„œ í•„ìš”í•œ DTO ë¥¼ ìƒì‚°í•˜ê³  ìƒì„±ìì—ì„œ Collection ì€ ì œì™¸í•œë‹¤.
2. ì—°ê´€ê´€ê³„ì— ìˆëŠ” OrderItem DTO í•˜ë‚˜ ë” ë§Œë“ ë‹¤.
3. Order ë¥¼ ì¡°íšŒí•˜ëŠ” Query ë¡œì§ì„ ë§Œë“ ë‹¤.
4. OrderItem ì„ ì¡°íšŒí•˜ëŠ” Query ë¬¸ì„ ë§Œë“ ë‹¤.
5. OrderItem ì˜ ê°’ì„ Order ì˜ Collection ì— ì§ì ‘ ë„£ì•„ì¤€ë‹¤.

<br>

ì •ë¦¬í•˜ìë©´ N : 1 ì„ ë¨¼ì € ì¡°íšŒí•œ í›„ 1 : N ì„ ë³„ë„ë¡œ ì¡°íšŒí•´ ìˆ˜ë™ìœ¼ë¡œ ì—°ê²°í•˜ëŠ” ë°©ì‹ì´ë‹¤.

<br>

### ğŸ“Â ë¬¸ì œì 

ì—°ê´€ê´€ê³„ ê°¯ìˆ˜ë§Œí¼ ì¿¼ë¦¬ë¬¸ì´ ë” ë°œìƒë˜ëŠ” N+1 ë¬¸ì œê°€ ìƒê¸°ê²Œ ëœë‹¤.

<br>

- OrderQueryDto

```java
package jpabook.jpashop.repository.order.query;

import jpabook.jpashop.domain.Address;
import jpabook.jpashop.domain.OrderStatus;
import lombok.Data;

import java.time.LocalDateTime;
import java.util.List;

@Data
public class OrderQueryDto {

    private Long orderId;
    private String name;
    private LocalDateTime orderDate;
    private OrderStatus orderStatus;
    private Address address;
    private List<OrderItemQueryDto> orderItems;

    public OrderQueryDto(Long orderId, String name, LocalDateTime orderDate, OrderStatus orderStatus, Address address) {
        this.orderId = orderId;
        this.name = name;
        this.orderDate = orderDate;
        this.orderStatus = orderStatus;
        this.address = address;
    }
}
```

- OrderItemQueryDto

```java
package jpabook.jpashop.repository.order.query;

import lombok.Data;

@Data
public class OrderItemQueryDto {

    private Long orderId;
    private String itemName;
    private int orderPrice;
    private int count;

    public OrderItemQueryDto(Long orderId, String itemName, int orderPrice, int count) {
        this.orderId = orderId;
        this.itemName = itemName;
        this.orderPrice = orderPrice;
        this.count = count;
    }
}
```

- OrderQueryRepository

```java
package jpabook.jpashop.repository.order.query;

import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

import javax.persistence.EntityManager;
import java.util.List;

@Repository
@RequiredArgsConstructor
public class OrderQueryRepository {

    private final EntityManager em;

    public List<OrderQueryDto> findOrderQueryDto() {
        List<OrderQueryDto> result = findOrders();
        result.forEach(o ->{
            List<OrderItemQueryDto> orderItems = findOrderItems(o.getOrderId());
            o.setOrderItems(orderItems);
        });
        return result;
    }

    private List<OrderQueryDto> findOrders() {
        return em.createQuery(
                "select new jpabook.jpashop.repository.order.query.OrderQueryDto(o.id, m.name, o.orderDate, o.status, d.address)" +
                        " from Order o" +
                        " join o.member m" +
                        " join o.delivery d", OrderQueryDto.class)
                .getResultList();
    }

    // item ì€ OrderItem ì…ì¥ì—ì„œ N : 1 ì˜ ê´€ê³„ê¸° ë•Œë¬¸ì— join ë¬¸ìœ¼ë¡œ ì¡°íšŒí•´ë„ ë¬´ê´€í•˜ë‹¤.
    private List<OrderItemQueryDto> findOrderItems(Long orderId) {
        return em.createQuery(
                "select new jpabook.jpashop.repository.order.query.OrderItemQueryDto(oi.order.id, i.name, oi.orderPrice, oi.count)" +
                        " from OrderItem oi" +
                        " join oi.item i" +
                        " where oi.order.id = :orderId", OrderItemQueryDto.class)
                .setParameter("orderId",orderId)
                .getResultList();
    }

}
```

- Controller method

```java
    // V4 JPA ì—ì„œ DTO ë¡œ ì§ì ‘ ì¡°íšŒ
    @GetMapping("/api/v4/orders")
    public List<OrderQueryDto> orderV4(){
        return orderQueryRepository.findOrderQueryDto();
    }
```