# JPA ê°œë°œ

## âœï¸Â Entity

- @Entity ì€ Java ê°€ ì‚¬ìš©í•˜ëŠ” ê°ì²´ë¼ëŠ” ëœ»ì´ë‹¤.
    - @Entity ê°€ ìˆì–´ì•¼ JPA ê°€ ì¸ì‹í•  ìˆ˜ ìˆë‹¤.
    - @Entity í•„ë“œ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìë™ìœ¼ë¡œ Table ì´ ìƒì„±ëœë‹¤.
- @GeneratedValue ëŠ” PK ìƒì„± ê°’ì„ DB ì—ì„œ ìƒì„±í•˜ëŠ” IDENTITY ë°©ì‹ì„ ì‚¬ìš©í•œë‹¤.
- @Column ì€ ê°ì²´ì˜ í•„ë“œë¥¼ Table ì˜ Column ê³¼ ë§¤í•‘í•œë‹¤.
    - í•„ë“œëª…ê³¼ Column ëª…ì´ ë™ì¼í• ê²½ìš° ìƒëµí•  ìˆ˜ ìˆë‹¤.
        - ìë™ìœ¼ë¡œ ë‚™íƒ€ ì‘ì„±ë²•ê³¼ ìŠ¤ë„¤ì´í¬ ì‘ì„±ë²•ì„ ë²ˆì—­í•´ì¤˜ ì‚¬ì‹¤ ì§€ê¸ˆ ìƒí™©ì—ì„œë„ ìƒëµí•  ìˆ˜ ìˆë‹¤.
    - length ëŠ” JPA ì˜ ë§¤í•‘ ì •ë³´ë¡œ ì»¬ëŸ¼ì˜ ê¸¸ì´ ê°’ìœ¼ë¡œ í™œìš©ëœë‹¤.
        - length = 10 ì€ vachar 10 ê³¼ ë™ì¼í•¨
- ê¸°ë³¸ìƒì„±ì
    - JPA ì˜ Entity ëŠ” ê¸°ë³¸ìƒì„±ìë¥¼ í•„ìˆ˜ë¡œ í•„ìš”ë¡œí•œë‹¤.
    - í”„ë¡ì‹œ ê°™ì€ ê¸°ìˆ ë“¤ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œ ê¸°ë³¸ìƒì„±ìë¥¼ í•„ìš”ë¡œ í•¨

```java
package hello.itemservice.domain;

import lombok.Data;

import javax.persistence.*;

@Data
@Entity
public class Item {

    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "item_name", length = 10)
    private String itemName;
    private Integer price;
    private Integer quantity;

    // JPA ì—ì„œëŠ” ê¸°ë³¸ìƒì„±ìê°€ í•„ìˆ˜ë¡œ ë“¤ì–´ê°€ì•¼ í•œë‹¤.
    public Item() {
    }

    public Item(String itemName, Integer price, Integer quantity) {
        this.itemName = itemName;
        this.price = price;
        this.quantity = quantity;
    }
}
```

<br>

## âœï¸Â Repository

- JPQL
    - JPA ì—ì„œ Query ë¬¸ì„ ì‘ì„±í•  ë•Œ ì‚¬ìš©ë˜ëŠ” ë¬¸ë²•
    - JPQL ë¬¸ë²•ì€ SQL ê³¼ ê±°ì˜ ë¹„ìŠ·í•˜ì§€ë§Œ,
    Table ì„ ëŒ€ìƒìœ¼ë¡œ í•˜ëŠ”ê²ƒì´ ì•„ë‹Œ Entity ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì‘ì„±í•œë‹¤.
    - from Item i ì—ì„œ Item ì€ Entity Item ì„ ëœ»í•œë‹¤.
    - JPQL ë„ ë™ì  ì¿¼ë¦¬ì— ì•½í•˜ë‹¤ëŠ” ë‹¨ì ì´ ìˆë‹¤.

[ğŸ”—Â ë³€ê²½ ê°ì§€](https://github.com/choideakook/TIL/blob/main/Spring/3%20JPA%20í™œìš©1/4%20Web%20ê³„ì¸µ%20ê°œë°œ/230109%207%20ë³€ê²½%20ê°ì§€ì™€%20ë³‘í•©%20(Dirty%20Checking%20&%20Merge).md)

```java
package hello.itemservice.repository.jpa;

import hello.itemservice.domain.Item;
import hello.itemservice.repository.ItemRepository;
import hello.itemservice.repository.ItemSearchCond;
import hello.itemservice.repository.ItemUpdateDto;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;

import javax.persistence.EntityManager;
import javax.persistence.TypedQuery;
import java.util.List;
import java.util.Optional;

@Slf4j
@Repository
@Transactional
@RequiredArgsConstructor
public class JpaItemRepository implements ItemRepository {

    private final EntityManager em;

    @Override
    public Item save(Item item) {
        em.persist(item);
        return item;
    }

    // ë³€ê²½ ê°ì§€ë¥¼ í†µí•œ ìë™ ìˆ˜ì •
    @Override
    public void update(Long itemId, ItemUpdateDto updateParam) {
        Item findItem = em.find(Item.class, itemId);
        findItem.setItemName(updateParam.getItemName());
        findItem.setPrice(updateParam.getPrice());
        findItem.setQuantity(updateParam.getQuantity());
    }

    @Override
    @Transactional(readOnly = true)
    public Optional<Item> findById(Long id) {
        Item item = em.find(Item.class, id);
        return Optional.ofNullable(item);
    }

    @Override
    @Transactional(readOnly = true)
    public List<Item> findAll(ItemSearchCond cond) {
        // jpa ì—ì„œ query ë¬¸ì„ ì‘ì„±í•  ë• jpql ë¬¸ì„ ì‚¬ìš©í•œë‹¤.
        String jpql = "select i from Item i";

        // ë™ì  ì¿¼ë¦¬
        Integer maxPrice = cond.getMaxPrice();
        String itemName = cond.getItemName();
        if (StringUtils.hasText(itemName) || maxPrice != null) {
            jpql += " where";
        }
        boolean andFlag = false;
        if (StringUtils.hasText(itemName)) {
            jpql += " i.itemName like concat('%',:itemName,'%')";
            andFlag = true;
        }
        if (maxPrice != null) {
            if (andFlag) {
                jpql += " and";
            }
            jpql += " i.price <= :maxPrice";
        }
        log.info("jpql={}", jpql);
        TypedQuery<Item> query = em.createQuery(jpql, Item.class);
        if (StringUtils.hasText(itemName)) {
            query.setParameter("itemName", itemName);
        }
        if (maxPrice != null) {
            query.setParameter("maxPrice", maxPrice);
        }
        return query.getResultList();
    }
}
```

<br>

## âœï¸Â Config

- EntityManager ë¥¼ Repository ì— ì£¼ì…í•´ì£¼ë©´ ëœë‹¤.

```java
package hello.itemservice.config;

import hello.itemservice.repository.ItemRepository;
import hello.itemservice.repository.jpa.JpaItemRepository;
import hello.itemservice.repository.myBaits.ItemMapper;
import hello.itemservice.repository.myBaits.MyBatisItemRepository;
import hello.itemservice.service.ItemService;
import hello.itemservice.service.ItemServiceV1;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import javax.persistence.EntityManager;

@Configuration
public class JpaConfig {
    
    private final EntityManager em;

    public JpaConfig(EntityManager em) {
        this.em = em;
    }

    @Bean
    public ItemService itemService() {
        return new ItemServiceV1(itemRepository());
    }

    @Bean
    public ItemRepository itemRepository() {
        return new JpaItemRepository(em);

    }
}
```

<br>

## âœï¸Â application

- Import ë¥¼ ë³€ê²½í•´ì¤€ë‹¤.

```java
@Slf4j
@Import(JpaConfig.class)
@SpringBootApplication(scanBasePackages = "hello.itemservice.web")
public class ItemServiceApplication {

	public static void main(String[] args) {
		SpringApplication.run(ItemServiceApplication.class, args);
	}
```