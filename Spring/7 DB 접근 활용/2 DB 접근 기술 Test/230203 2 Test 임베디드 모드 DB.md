# Test ì„ë² ë””ë“œ ëª¨ë“œ DB

## âœï¸Â ì„ë² ë””ë“œ ëª¨ë“œ DB

### ğŸ“Â í•„ìš”ì„±

Test ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ì„œ ë³„ë„ì˜ DB ë¥¼ ìš´ì˜í•˜ëŠ”ê²ƒì€ ë§¤ìš° ë²ˆê±°ë¡œìš´ ì¼ì´ë‹¤.

ë‹¨ìˆœí•˜ê²Œ test ë¥¼ ì‚¬ìš©í•  ëª©ì ìœ¼ë¡œ DB ê°€ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— Test ê°€ ëë‚˜ë©´ DB ë¥¼ ì œê±°í•´ë„ ë¬´ë°©í•˜ë‹¤.

### ğŸ“Â ì„ë² ë””ë“œ ëª¨ë“œë¡œ ë¬¸ì œ í•´ê²°

âš ï¸Â ì„ë² ë””ë“œ ëª¨ë“œë€

H2 DB ëŠ” java ë¡œ ê°œë°œë˜ì—ˆê³ , JVM ì•ˆì—ì„œ ë©”ëª¨ë¦¬ ëª¨ë“œë¡œ ë™ì‘í•˜ëŠ” ê¸°ëŠ¥ì„ ì¬ê³µí•œë‹¤.

ë”°ë¼ì„œ application ì´ ì‹¤í–‰ë  ë•Œ H2 DB ë„ JVM ë©”ëª¨ë¦¬ì— í¬í•¨í•´ì„œ í•¨ê»˜ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.

ì¦‰ DB ê°€ application ì— ë‚´ì¥ë˜ì–´ ì‹¤í–‰ë˜ê³  ì´ë¥¼ ì„ë² ë””ë“œ ëª¨ë“œ (Embedded mode) ë¼ê³  í•œë‹¤.

- application ì´ ì¢…ë£Œë˜ë©´ H2 DB ë„ í•¨ê»˜ ì¢…ë£Œë˜ê³  data ë„ ëª¨ë‘ ì‚¬ë¼ì§„ë‹¤.

<br>

- ì„ë² ë””ë“œ ëª¨ë“œ í™˜ê²½ì„¤ì •

```java
package hello.itemservice;

import hello.itemservice.config.*;
import hello.itemservice.repository.ItemRepository;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Import;
import org.springframework.context.annotation.Profile;
import org.springframework.jdbc.datasource.DriverManagerDataSource;

import javax.sql.DataSource;

@Slf4j
@Import(JdbcTemplateV3Config.class)
@SpringBootApplication(scanBasePackages = "hello.itemservice.web")
public class ItemServiceApplication {

	public static void main(String[] args) {
		SpringApplication.run(ItemServiceApplication.class, args);
	}

	@Bean
	@Profile("local")
	public TestDataInit testDataInit(ItemRepository itemRepository) {
		return new TestDataInit(itemRepository);
	}

	@Bean 
  // test ì‹¤í–‰ì‹œ ì‹¤í–‰ë˜ëŠ” ë¡œì§
  // profiles - active ì—ì„œ ì„¤ì •ì„ ë³€ê²½í•´ ì£¼ì–´ì•¼ í•œë‹¤.
	@Profile("test") 
	public DataSource dataSource() {
		log.info("ë©”ëª¨ë¦¬ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”");
		// test ë¥¼ ì‹¤í–‰í•  ë• Data Source (ë“œë¼ì´ë²„) ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì§€ì •í•˜ëŠ” ë¡œì§
		DriverManagerDataSource dataSource = new DriverManagerDataSource();
		// H2 DB ë“œë¼ì´ë²„ë¥¼ ì§ì ‘ ì§€ì •
		dataSource.setDriverClassName("org.h2.Driver");
		// test ë¥¼ ì‚¬ìš©í•  ë•Œ ì‚¬ìš©í•˜ëŠ” db connection
		// mem ë¡œ ì„¤ì •í•˜ë©´ ë©”ëª¨ë¦¬ ëª¨ë“œ ë¼ëŠ” ëœ»ì´ë‹¤.
		dataSource.setUrl("jdbc:h2:mem:db;DB_CLOSE_DELAY=-1");
		dataSource.setUsername("sa");
		dataSource.setPassword("");
		return dataSource;
	}
}
```

<br>

- application.yml í™˜ê²½ì„¤ì •

```java
spring:
  profiles:
    active: test // active ì— profiles ì´ ì…ë ¥ëœ method ë§Œ ì‘ë™ì´ ëœë‹¤.
```

â—ì´ëŒ€ë¡œ ì‹¤í–‰í•˜ë©´ Memory DB ì— Table ì´ ì—†ì–´ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ê²Œ ëœë‹¤.

- ìˆ˜ë™ìœ¼ë¡œ Table ì„ ìƒì„±í•  ìˆ˜ ìˆì§€ë§Œ application ì´ ì¢…ë£Œë  ë•Œ table ë„ ì¢…ë£Œë˜ê¸° ë•Œë¬¸ì— ë²ˆê±°ë¡œìš´ ì‘ì—…ì´ ëœë‹¤.

<br>

### ğŸ“Â ê¸°ë³¸ SQL ìŠ¤í¬ë¦½íŠ¸ë¡œ Table ì„ ìƒì„±í•´ ë¬¸ì œ í•´ê²°

Spring Boot ê°€ ì œê³µí•˜ëŠ” ê¸°ë³¸ SQL ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•´ applcation ë¡œë”© ì‹œì ì— DB ë¥¼ ì´ˆê¸°í™” í•˜ëŠ” ê¸°ëŠ¥ì„ ì‚¬ìš©í•œë‹¤.

test - resources ì— schema.sql file ì„ ìƒì„±í•˜ê³  SQL ë¬¸ì„ ì‘ì„±í•´ì¤€ë‹¤.

- application ë¡œë”© ì‹œì ì— í•´ë‹¹ SQL ë¬¸ì„ ë¨¼ì € ì‹¤í–‰í•´ Table ì„ ìƒì„±í•´ ë†“ëŠ”ë‹¤.
- schema.sql íŒŒì¼ëª…ì´ ë‹¤ë¥´ë©´ ì¸ì‹ì´ ì•ˆë˜ë‹ˆ ì£¼ì˜
- ë©”ëª¨ë¦¬ë¥¼ ì‚¬ìš©í•œ DB ê¸° ë•Œë¬¸ì— H2 ì½˜ì†”ê³¼ ì—°ê²°ì´ ëŠê²¨ë„ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤.

```sql
drop table if exists item CASCADE;
create table item
(
    id        bigint generated by default as identity,
    item_name varchar(10),
    price     integer,
    quantity  integer,
    primary key (id)
);
```

<br>

## âœï¸Â Spring boot ì™€ ì„ë² ë””ë“œ ëª¨ë“œ

ì´ ì „ì˜ ë°©ì‹ìœ¼ë¡œ ì„ë² ë””ë“œ ëª¨ë“œ DB ë¥¼ ìš´ì˜í•  ìˆ˜ ìˆì§€ë§Œ ì§ì ‘ Test ìš©  í”„ë¡œí•„ method ë¥¼ ë§Œë“¤ì–´ì•¼ í•˜ëŠ” ë²ˆê±°ë¡œì›€ì´ ìˆì§€ë§Œ

Spring boot ê°€ ì œê³µí•˜ëŠ” ì„ë² ë””ë“œ DB ë¥¼ ì‚¬ìš©í•˜ë©´ ì´ëŸ¬í•œ ë¬¸ì œì ì„ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

### ğŸ“Â í”„ë¡œí•„ ì œê±°

Spring boot ê°€ ì œê³µí•˜ëŠ” ì„ë² ë””ë“œ DB ë¥¼ ì‚¬ìš©í•˜ë©´ í”„ë¡œí•„ì„ ë”°ë¡œ ì‘ì„±í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

```java
package hello.itemservice;

import hello.itemservice.config.*;
import hello.itemservice.repository.ItemRepository;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Import;
import org.springframework.context.annotation.Profile;
import org.springframework.jdbc.datasource.DriverManagerDataSource;

import javax.sql.DataSource;

@Slf4j
@Import(JdbcTemplateV3Config.class)
@SpringBootApplication(scanBasePackages = "hello.itemservice.web")
public class ItemServiceApplication {

	public static void main(String[] args) {
		SpringApplication.run(ItemServiceApplication.class, args);
	}

	@Bean
	@Profile("local")
	public TestDataInit testDataInit(ItemRepository itemRepository) {
		return new TestDataInit(itemRepository);
	}

//	@Bean
//	@Profile("test")
//	public DataSource dataSource() {
//		log.info("ë©”ëª¨ë¦¬ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”");
//		DriverManagerDataSource dataSource = new DriverManagerDataSource();
//		dataSource.setDriverClassName("org.h2.Driver");
//		dataSource.setUrl("jdbc:h2:mem:db;DB_CLOSE_DELAY=-1");
//		dataSource.setUsername("sa");
//		dataSource.setPassword("");
//		return dataSource;
//	}
}
```

<br>

### ğŸ“Â Test application í™˜ê²½ì„¤ì •

H2 DB ê´€ë ¨ í™˜ê²½ì„¤ì •ì„ ëª¨ë‘ ì œê±°í•œë‹¤.

- DB ì— ì ‘ê·¼í•˜ëŠ” ëª¨ë“  ì„¤ì •ì •ë³´ê°€ ì‚¬ë¼ì§„ë‹¤.
- ë³„ë‹¤ë¥¸ ì •ë³´ê°€ ì—†ì„ê²½ìš° Spring boot ëŠ” ì„ë² ë””ë“œ ëª¨ë“œë¡œ ì ‘ê·¼í•˜ëŠ” Data Source ë¥¼ ë§Œë“¤ì–´ ì œê³µí•˜ê²Œ ëœë‹¤.

```yaml
spring:
  profiles:
    active: test

#  datasource:
#    url: jdbc:h2:tcp://localhost/~/testcase
#    username: sa
#    password:
#    driver-class-name: org.h2.Driver

logging:
  level:
    org.hibernate.SQL: debug
```

DB ì— ì—°ê²°í•˜ì§€ ì•Šì•„ë„ ì •ìƒì ìœ¼ë¡œ Test ê°€ ì™„ë£Œëœë‹¤.

â—Â Table ì„ ìƒì„±í•˜ëŠ” schema.sql ì€ ì‚­ì œí•˜ë©´ ì•ˆëœë‹¤.